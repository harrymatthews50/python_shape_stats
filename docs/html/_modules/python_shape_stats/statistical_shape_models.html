<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>python_shape_stats.statistical_shape_models &mdash; python_shape_stats 0.1 documentation</title>
      <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script src="../../_static/sphinx_highlight.js"></script>
        <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            python_shape_stats
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <!-- Local TOC -->
              <div class="local-toc"></div>
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">python_shape_stats</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Module code</a></li>
      <li class="breadcrumb-item active">python_shape_stats.statistical_shape_models</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for python_shape_stats.statistical_shape_models</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">scipy.linalg</span>
<span class="kn">from</span> <span class="nn">scipy.sparse</span> <span class="kn">import</span> <span class="n">spdiags</span>
<span class="kn">from</span> <span class="nn">scipy.stats</span> <span class="kn">import</span> <span class="n">chi2</span>
<span class="kn">from</span> <span class="nn">sklearn.cross_decomposition</span> <span class="kn">import</span> <span class="n">PLSRegression</span>
<span class="kn">from</span> <span class="nn">python_shape_stats</span> <span class="kn">import</span> <span class="n">helpers</span><span class="p">,</span> <span class="n">procrustes</span>
<span class="kn">from</span> <span class="nn">sklearn.model_selection</span> <span class="kn">import</span> <span class="n">KFold</span>
<span class="kn">import</span> <span class="nn">joblib</span>
<span class="kn">from</span> <span class="nn">joblib_progress</span> <span class="kn">import</span> <span class="n">joblib_progress</span>
<span class="kn">from</span> <span class="nn">abc</span> <span class="kn">import</span> <span class="n">ABC</span><span class="p">,</span> <span class="n">abstractmethod</span><span class="p">,</span> <span class="n">abstractproperty</span><span class="p">,</span> <span class="n">abstractclassmethod</span><span class="p">,</span> <span class="n">abstractstaticmethod</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">tqdm</span> <span class="kn">import</span> <span class="n">tqdm</span>
<span class="kn">import</span> <span class="nn">pyvista</span>


<div class="viewcode-block" id="PCA"><a class="viewcode-back" href="../../python_shape_stats.html#python_shape_stats.statistical_shape_models.PCA">[docs]</a><span class="k">class</span> <span class="nc">PCA</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Implements a principal components analysis of a data matrix with several</span>
<span class="sd">    methods for determining the number of principal components.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_eig_vec</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_eig_val</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_transformed_training_data</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_initial_var</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_center_vec</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_standardize_cols_vec</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_n_train_features</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_n_samples</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_params</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_initial_eig_val</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_parallel_analysis_results</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cross_validation_results</span> <span class="o">=</span> <span class="kc">None</span>


    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">eig_vec</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The right singular vectors (the PCs) of the data matrix . The first dimension corresponds to PCs, the second to features.</span>

<span class="sd">        :type: np.ndarray</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_eig_vec</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">eig_val</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The total variance explained by each PC. This is computed from the singular values of the training data matrix</span>

<span class="sd">        :math:`\\frac{s^2}{k}` where :math:`s` is the singular values and</span>
<span class="sd">        :math:`k` is the number of observations (rows in the training data matrix). If x is column-mean centered in the call to &#39;fit&#39; This is equal to the sample variance in each dimension of the transformed data.</span>

<span class="sd">        :type: np.ndarray</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_eig_val</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">eig_std</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The square root of &#39;self.eig_val&#39;. If x was column mean centered during the call to &#39;self.fit&#39; these are the sample standard deviations of the transformed training data</span>

<span class="sd">        :type: np.ndarray</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">eig_val</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">eig_val</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">cumulative_perc_var</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The cumulative percentage of the total initial variance explained. The :math:`i_{th}` entry is the percentage of variace explained by the pcs 1-i</span>

<span class="sd">        :type: np.ndarray</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">eig_val</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">eig_val</span><span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">_initial_var</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">n_dim</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The number of dimensions (PCs) currently in the model.</span>

<span class="sd">        :type: int</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">eig_val</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">eig_val</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">transformed_training_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Coordinates of the training data in the space spanned by the PCs. Rows correspond to observations, columns to PCs</span>
<span class="sd">        These are alternatively called &#39;PC scores&#39;</span>

<span class="sd">        :type: np.ndarray</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_transformed_training_data</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">center_vec</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The vector used to center the columns of x. Using default keyword arguments to &#39;fit&#39; this is the column mean of</span>
<span class="sd">        the training data matrix</span>

<span class="sd">        :type: np.ndarray</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_center_vec</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_center_vec</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_n_train_features</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_n_train_features</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">standardize_cols_vec</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The vector used to standardize the columns of x. If standardize_cols == True during the call to fit this will be the column root mean square deviation from &#39;center_vec&#39;</span>

<span class="sd">        :type: np.ndarray</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_standardize_cols_vec</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_standardize_cols_vec</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_n_train_features</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_n_train_features</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">params</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Parameters used during the last call to self.fit</span>

<span class="sd">        :type: dict</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_params</span>


    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_fit</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">center</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">center_vec</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">standardize_cols</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="n">params</span> <span class="o">=</span> <span class="nb">locals</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">center</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">center_vec</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">center_vec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">x0</span> <span class="o">=</span> <span class="n">x</span> <span class="o">-</span> <span class="n">center_vec</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">x0</span> <span class="o">=</span> <span class="n">x</span>
            <span class="n">center_vec</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="n">standardize_cols</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">standardize_cols_vec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">x0</span><span class="p">)),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">x0</span> <span class="o">=</span> <span class="n">x0</span> <span class="o">/</span> <span class="n">standardize_cols_vec</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">standardize_cols_vec</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="n">u</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">vt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">svd</span><span class="p">(</span><span class="n">x0</span><span class="p">,</span> <span class="n">full_matrices</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">n</span> <span class="o">=</span> <span class="n">x0</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">eig_val</span> <span class="o">=</span> <span class="n">s</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">/</span> <span class="p">(</span><span class="n">n</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">eig_vec</span> <span class="o">=</span> <span class="n">vt</span>
        <span class="n">outputs</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;_center_vec&#39;</span><span class="p">:</span> <span class="n">center_vec</span><span class="p">,</span> <span class="s1">&#39;_standardize_cols_vec&#39;</span><span class="p">:</span> <span class="n">standardize_cols_vec</span><span class="p">,</span> <span class="s1">&#39;_eig_val&#39;</span><span class="p">:</span> <span class="n">eig_val</span><span class="p">,</span>
                   <span class="s1">&#39;_eig_vec&#39;</span><span class="p">:</span> <span class="n">eig_vec</span><span class="p">}</span>
        <span class="n">params</span><span class="p">[</span><span class="s1">&#39;x0&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">x0</span>
        <span class="k">return</span> <span class="n">outputs</span><span class="p">,</span> <span class="n">params</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_parallel_analysis_one_iter</span><span class="p">(</span><span class="n">x0</span><span class="p">,</span> <span class="n">seed</span><span class="p">):</span>
        <span class="n">rng</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">default_rng</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>
        <span class="n">shuff_x</span> <span class="o">=</span> <span class="n">helpers</span><span class="o">.</span><span class="n">randomize_matrix</span><span class="p">(</span><span class="n">x0</span><span class="p">,</span> <span class="n">rng</span><span class="p">)</span>
        <span class="n">out</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">PCA</span><span class="o">.</span><span class="n">_fit</span><span class="p">(</span><span class="n">shuff_x</span><span class="p">,</span> <span class="n">center</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">standardize_cols</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">out</span><span class="p">[</span><span class="s1">&#39;_eig_val&#39;</span><span class="p">]</span>

<div class="viewcode-block" id="PCA.fit_transform"><a class="viewcode-back" href="../../python_shape_stats.html#python_shape_stats.statistical_shape_models.PCA.fit_transform">[docs]</a>    <span class="k">def</span> <span class="nf">fit_transform</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">center</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">center_vec</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                      <span class="n">standardize_cols</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Fits the PCA model to training data x and applies the dimensionality reduction to x</span>

<span class="sd">        :param x: a k (observations) by n (features) matrix of training data</span>
<span class="sd">        :param center: if True the columns of x will be centered on center_vec prior to the SVD</span>
<span class="sd">        :param center_vec: if None the &#39;center_vec&#39; defaults to the column means of x and thus performs column mean centering of x</span>
<span class="sd">        :param standardize_cols: if True the columns of x will be standardized to have unit variance prior to the svd</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">center</span><span class="o">=</span><span class="n">center</span><span class="p">,</span> <span class="n">center_vec</span><span class="o">=</span><span class="n">center_vec</span><span class="p">,</span> <span class="n">standardize_cols</span><span class="o">=</span><span class="n">standardize_cols</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_transformed_training_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">x</span><span class="p">)</span></div>

<div class="viewcode-block" id="PCA.fit"><a class="viewcode-back" href="../../python_shape_stats.html#python_shape_stats.statistical_shape_models.PCA.fit">[docs]</a>    <span class="k">def</span> <span class="nf">fit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">center</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">center_vec</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">standardize_cols</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Fits the PCA model to training data x - uses the singular value decomposition of (column centered and standardized) x.</span>

<span class="sd">        :param x: a k (observations) by n (features) matrix</span>
<span class="sd">        :param center: if True the columns of x will be centered on center_vec prior to the SVD</span>
<span class="sd">        :param center_vec: if None the &#39;center_vec&#39; defaults to the column means of x and thus performs column mean centering of x</span>
<span class="sd">        :param standardize_cols: if True the columns of x will be standardized to have unit variance prior to the svd</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">outputs</span><span class="p">,</span> <span class="n">params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fit</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">center</span><span class="o">=</span><span class="n">center</span><span class="p">,</span> <span class="n">center_vec</span><span class="o">=</span><span class="n">center_vec</span><span class="p">,</span> <span class="n">standardize_cols</span><span class="o">=</span><span class="n">standardize_cols</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_params</span> <span class="o">=</span> <span class="n">params</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_center_vec</span> <span class="o">=</span> <span class="n">outputs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;_center_vec&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_standardize_cols_vec</span> <span class="o">=</span> <span class="n">outputs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;_standardize_cols_vec&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_eig_val</span> <span class="o">=</span> <span class="n">outputs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;_eig_val&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_eig_vec</span> <span class="o">=</span> <span class="n">outputs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;_eig_vec&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_n_samples</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_n_train_features</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_initial_var</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">eig_val</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_initial_eig_val</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">eig_val</span></div>

<div class="viewcode-block" id="PCA.transform"><a class="viewcode-back" href="../../python_shape_stats.html#python_shape_stats.statistical_shape_models.PCA.transform">[docs]</a>    <span class="k">def</span> <span class="nf">transform</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Perform the dimensionality reduction on x</span>

<span class="sd">        :param x: an l (observations) by n (features) matrix</span>
<span class="sd">        :return: an l (observations) by self.n_dim array of co-ordinates in the lower dimensional space</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">x0</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">center_vec</span><span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">standardize_cols_vec</span>
        <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">eig_vec</span> <span class="o">@</span> <span class="n">x0</span><span class="o">.</span><span class="n">T</span><span class="p">)</span><span class="o">.</span><span class="n">T</span></div>

<div class="viewcode-block" id="PCA.predict"><a class="viewcode-back" href="../../python_shape_stats.html#python_shape_stats.statistical_shape_models.PCA.predict">[docs]</a>    <span class="k">def</span> <span class="nf">predict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Reverses the dimensionality reduction to get back the original feature values from the transformed values</span>

<span class="sd">        :param x: an l (observations) x self.n_dim matrix (or a vector of length self.n_dim)</span>
<span class="sd">        :return: an array with l rows and n (features) columns</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">x</span> <span class="o">@</span> <span class="bp">self</span><span class="o">.</span><span class="n">eig_vec</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">standardize_cols_vec</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">center_vec</span></div>

<div class="viewcode-block" id="PCA.parallel_analysis"><a class="viewcode-back" href="../../python_shape_stats.html#python_shape_stats.statistical_shape_models.PCA.parallel_analysis">[docs]</a>    <span class="k">def</span> <span class="nf">parallel_analysis</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n_reps</span> <span class="p">:</span> <span class="nb">int</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">n_jobs</span> <span class="p">:</span> <span class="nb">int</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">seed</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">Generator</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Computes a &#39;null&#39; distribution of eigenvalue spectra derived from random matrices. Run this method then PCA.parallel_analysis_plot to visualise and interpret the results and determine the optimum number of principal components</span>

<span class="sd">        :param n_reps: number of repetitions to use in the parallel analysis</span>
<span class="sd">        :param n_jobs: number of jobs to run in parallel</span>
<span class="sd">        :param seed: random seed</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">rng</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">default_rng</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>
        <span class="n">ss</span> <span class="o">=</span> <span class="n">rng</span><span class="o">.</span><span class="n">bit_generator</span><span class="o">.</span><span class="n">_seed_seq</span>
        <span class="n">child_states</span> <span class="o">=</span> <span class="n">ss</span><span class="o">.</span><span class="n">spawn</span><span class="p">(</span><span class="n">n_reps</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">joblib_progress</span><span class="p">(</span><span class="s1">&#39;Running parallel analysis...&#39;</span><span class="p">,</span> <span class="n">n_reps</span><span class="p">):</span>
            <span class="n">args</span> <span class="o">=</span> <span class="n">joblib</span><span class="o">.</span><span class="n">Parallel</span><span class="p">(</span><span class="n">n_jobs</span><span class="o">=</span><span class="n">n_jobs</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">)(</span>
                <span class="n">joblib</span><span class="o">.</span><span class="n">delayed</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_parallel_analysis_one_iter</span><span class="p">)(</span><span class="bp">self</span><span class="o">.</span><span class="n">_params</span><span class="p">[</span><span class="s1">&#39;x0&#39;</span><span class="p">],</span> <span class="n">child_states</span><span class="p">[</span><span class="n">x</span><span class="p">])</span>
                <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_reps</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_parallel_analysis_results</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">(</span><span class="n">args</span><span class="p">)</span></div>



<div class="viewcode-block" id="PCA.scree_plot"><a class="viewcode-back" href="../../python_shape_stats.html#python_shape_stats.statistical_shape_models.PCA.scree_plot">[docs]</a>    <span class="k">def</span> <span class="nf">scree_plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ax</span> <span class="p">:</span> <span class="n">plt</span><span class="o">.</span><span class="n">Axes</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Makes a scree plot of the eigenvalue spectrum</span>

<span class="sd">        :param ax: optionally an axis handle</span>
<span class="sd">        :return: a tuple containing 1. the axis handle on which the plot is plotted and 2. a NoneType object</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">_eigen_value_plot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_initial_eig_val</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Scree Plot&#39;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span></div>

<div class="viewcode-block" id="PCA.cumulative_variance_plot"><a class="viewcode-back" href="../../python_shape_stats.html#python_shape_stats.statistical_shape_models.PCA.cumulative_variance_plot">[docs]</a>    <span class="k">def</span> <span class="nf">cumulative_variance_plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ax</span> <span class="p">:</span> <span class="n">plt</span><span class="o">.</span><span class="n">Axes</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plots the cumulative percentage of variance explained by each PC.</span>

<span class="sd">        :param ax: an axis on which to plot.</span>
<span class="sd">        :return: a tuple containing 1. the axis handle on which the plot is plotted and 2. a NoneType object</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">_eigen_value_plot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_initial_eig_val</span><span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">_initial_var</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span>
                                 <span class="n">eig_vals_label</span><span class="o">=</span><span class="s1">&#39;Cumulative Var. Exp.&#39;</span><span class="p">,</span>
                                 <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Cumulative Variance&#39;</span><span class="p">,</span> <span class="n">ylabel</span><span class="o">=</span><span class="s1">&#39;Variance</span><span class="se">\n</span><span class="s1">Explained (%)&#39;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span></div>

<div class="viewcode-block" id="PCA.parallel_analysis_plot"><a class="viewcode-back" href="../../python_shape_stats.html#python_shape_stats.statistical_shape_models.PCA.parallel_analysis_plot">[docs]</a>    <span class="k">def</span> <span class="nf">parallel_analysis_plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ax</span> <span class="p">:</span> <span class="n">plt</span><span class="o">.</span><span class="n">Axes</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ci_level</span> <span class="p">:</span> <span class="nb">float</span><span class="o">=</span><span class="mi">95</span><span class="p">,</span> <span class="n">threshold_level</span> <span class="p">:</span><span class="nb">float</span> <span class="o">=</span><span class="mi">95</span><span class="p">,</span> <span class="n">n_reps</span><span class="p">:</span> <span class="nb">int</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">n_jobs</span> <span class="p">:</span> <span class="nb">int</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                               <span class="n">recompute_parallel_analysis</span> <span class="p">:</span> <span class="nb">bool</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">seed</span> <span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">Generator</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plots the result of a parallel analysis to determine the number of principal components to retain.</span>
<span class="sd">        In a parallel analysis the observed eigenvalue spectrum is compared to a (&#39;null&#39;) distribution of eigenvalue spectra</span>
<span class="sd">        obtained from random matrices. If the observed eigenvalue for the ith principal component is greater</span>
<span class="sd">        than the specified threshold it is considered &#39;significant&#39;. The estimated number of components is the (k-1)th</span>
<span class="sd">        component where k is the index of the first non-significant component. The plot plots the threshold as a solid line.</span>
<span class="sd">        The null distribution is plotted as a shaded region that spans the 0-ci_level percentiles of this distribution.</span>

<span class="sd">        :param ax: an axis handle on which to plot</span>
<span class="sd">        :param ci_level: the upper limit of the null distribution (as a percentile) to plot as a shaded region</span>
<span class="sd">        :param threshold_level: the percentile of the null distribution, if the eigenvalue exceeds this it is considered significant</span>
<span class="sd">        :param n_reps: the number of repetitions to compute the null distribution (will be ignored if the null distribution has already been calculated by calling PCA.parallel_analysis and recompute_parallel_analysis==False)</span>
<span class="sd">        :param n_jobs: the number of jobs to run in parallel while computing the null distribution (will be ignored if the null distribution has already been calculated by calling PCA.parallel_analysis and recompute_parallel_analysis==False)</span>
<span class="sd">        :param recompute_parallel_analysis: if True will recompute the null distribution, even if ot has already been calculated</span>
<span class="sd">        :param seed: seed for the random number generator</span>
<span class="sd">        :return: a tuple containing 1. the axis on which the plot is plotted and 2. the estimated number of principal components</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># determine whether the empirical null distribution needs to be recalculated</span>
        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_parallel_analysis_results</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="o">|</span> <span class="n">recompute_parallel_analysis</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">parallel_analysis</span><span class="p">(</span><span class="n">n_reps</span><span class="o">=</span><span class="n">n_reps</span><span class="p">,</span> <span class="n">n_jobs</span><span class="o">=</span><span class="n">n_jobs</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="n">seed</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">_eigen_value_plot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_initial_eig_val</span><span class="p">,</span> <span class="n">distr</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_parallel_analysis_results</span><span class="p">,</span>
                                 <span class="n">distr_label</span><span class="o">=</span><span class="s1">&#39;Null Spectra&#39;</span><span class="p">,</span> <span class="n">ci_level</span><span class="o">=</span><span class="n">ci_level</span><span class="p">,</span>
                                 <span class="n">threshold_level</span><span class="o">=</span><span class="n">threshold_level</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Parallel</span><span class="se">\n</span><span class="s1">Analysis&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="PCA.broken_stick_plot"><a class="viewcode-back" href="../../python_shape_stats.html#python_shape_stats.statistical_shape_models.PCA.broken_stick_plot">[docs]</a>    <span class="k">def</span> <span class="nf">broken_stick_plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ax</span> <span class="p">:</span> <span class="n">plt</span><span class="o">.</span><span class="n">Axes</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ci_level</span> <span class="p">:</span><span class="nb">float</span><span class="o">=</span><span class="mi">95</span><span class="p">,</span> <span class="n">threshold_level</span><span class="p">:</span> <span class="nb">float</span><span class="o">=</span><span class="mi">95</span><span class="p">,</span> <span class="n">n_reps</span><span class="p">:</span> <span class="nb">int</span><span class="o">=</span><span class="mi">1000</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plots the result of a broken stick analysis to determine the number of principal components to retain.</span>
<span class="sd">        In a broken stick analysis the observed eigenvalue spectrum is compared to a (&#39;null&#39;) distribution of eigenvalue spectra</span>
<span class="sd">        produced by randomly uniformly splitting the total variance ito the maximum number of principal components possible. If the observed eigenvalue for the ith principal component is greater</span>
<span class="sd">        than the specified threshold it is considered &#39;significant&#39;. The estimated number of components is the (k-1)th</span>
<span class="sd">        component where k is the index of the first non-significant component. The plot plots the threshold as a solid line.</span>
<span class="sd">        The null distribution is plotted as a shaded region that spans the 0-ci_level percentiles of this distribution.</span>

<span class="sd">        :param ax: an axis handle on which to plot</span>
<span class="sd">        :param ci_level: the upper limit of the null distribution (as a percentile) to plot as a shaded region</span>
<span class="sd">        :param threshold_level: the percentile of the null distribution, if the eigenvalue exceeds this it is considered significant</span>
<span class="sd">        :param n_reps: the number of repetitions to perform to estimate the broken stick distribution</span>
<span class="sd">        :return: a tuple containing 1. the axis on which the plot is plotted and 2. the estimated number of principal components</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># get the empirical broken stick distribution</span>
        <span class="n">N</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_initial_eig_val</span><span class="p">)</span>
        <span class="n">lengths</span> <span class="o">=</span> <span class="n">helpers</span><span class="o">.</span><span class="n">broken_stick_empirical</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">n_reps</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_initial_var</span>
        <span class="k">return</span> <span class="n">_eigen_value_plot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_initial_eig_val</span><span class="p">,</span> <span class="n">distr</span><span class="o">=</span><span class="n">lengths</span><span class="p">,</span> <span class="n">distr_label</span><span class="o">=</span><span class="s1">&#39;Null Spectra&#39;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span>
                                 <span class="n">ci_level</span><span class="o">=</span><span class="n">ci_level</span><span class="p">,</span>
                                 <span class="n">threshold_level</span><span class="o">=</span><span class="n">threshold_level</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Broken Stick&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="PCA.trim_no_pcs"><a class="viewcode-back" href="../../python_shape_stats.html#python_shape_stats.statistical_shape_models.PCA.trim_no_pcs">[docs]</a>    <span class="k">def</span> <span class="nf">trim_no_pcs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">no_pcs</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Modifies the object in situ, removing the specified number of pcs</span>

<span class="sd">        :param no_pcs: the number of pcs to retain</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_eig_vec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_eig_vec</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">no_pcs</span><span class="p">,</span> <span class="p">:]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_eig_val</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_eig_val</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">no_pcs</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_transformed_training_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_transformed_training_data</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">:</span><span class="n">no_pcs</span><span class="p">]</span></div>

<div class="viewcode-block" id="PCA.trim_perc_var"><a class="viewcode-back" href="../../python_shape_stats.html#python_shape_stats.statistical_shape_models.PCA.trim_perc_var">[docs]</a>    <span class="k">def</span> <span class="nf">trim_perc_var</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pct_var</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Modifies the object in situ, removing the number of pcs explaining up to the specified amount of variance</span>

<span class="sd">        :param pct_var: the percentage of variance s to retain</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">pct_var</span> <span class="o">&lt;=</span> <span class="mf">0.</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">pct_var</span> <span class="o">&gt;=</span> <span class="mf">100.</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;pct_var must be between 0 and 100&#39;</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cumulative_perc_var</span> <span class="o">&gt;=</span> <span class="n">pct_var</span><span class="p">)</span>
        <span class="n">no_pcs</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">no_pcs</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_dim</span><span class="p">:</span>
            <span class="n">no_pcs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_dim</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trim_no_pcs</span><span class="p">(</span><span class="n">no_pcs</span><span class="p">)</span></div>

<div class="viewcode-block" id="PCA.weighted_transform_to_model"><a class="viewcode-back" href="../../python_shape_stats.html#python_shape_stats.statistical_shape_models.PCA.weighted_transform_to_model">[docs]</a>    <span class="k">def</span> <span class="nf">weighted_transform_to_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">weights</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">max_m_dist</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Performs the dimensionality reduction on a single observation with weights that increase/decrease the infleunce</span>
<span class="sd">        of a given feature on the solution. The solution can also be constrained to lie within a specified Mahalanobis</span>
<span class="sd">        distance of the origin.</span>

<span class="sd">        :param x: a single observation in the original feature space</span>
<span class="sd">        :param weights: a weight for each feature</span>
<span class="sd">        :param max_m_dist: the maximum Mahalanobis distance the transformed values can be from the origin</span>
<span class="sd">        :return: the transformed values of x</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">weights</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">weights</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">helpers</span><span class="o">.</span><span class="n">validate_vector</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="s1">&#39;x&#39;</span><span class="p">)</span>
        <span class="n">weights</span> <span class="o">=</span> <span class="n">helpers</span><span class="o">.</span><span class="n">validate_vector</span><span class="p">(</span><span class="n">weights</span><span class="p">,</span> <span class="s1">&#39;weights&#39;</span><span class="p">)</span>
        <span class="n">x0</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">center_vec</span><span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">standardize_cols_vec</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">spdiags</span><span class="p">(</span><span class="n">weights</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
        <span class="n">aq</span> <span class="o">=</span> <span class="n">a</span> <span class="o">@</span> <span class="bp">self</span><span class="o">.</span><span class="n">eig_vec</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">eig_val</span><span class="p">)</span>
        <span class="n">u</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">v</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">svd</span><span class="p">(</span><span class="n">aq</span><span class="p">,</span> <span class="n">full_matrices</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">w</span> <span class="o">=</span> <span class="n">s</span> <span class="o">/</span> <span class="p">(</span><span class="n">s</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">fit</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">eig_val</span><span class="p">)</span> <span class="o">@</span> <span class="n">v</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">w</span><span class="p">)</span> <span class="o">@</span> <span class="n">u</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">a</span> <span class="o">@</span> <span class="n">x0</span>
        <span class="k">if</span> <span class="n">max_m_dist</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">curr_m_dist</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_distance</span><span class="p">(</span><span class="n">fit</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">curr_m_dist</span> <span class="o">&gt;</span> <span class="n">max_m_dist</span><span class="p">:</span>
                <span class="n">fit</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale_vec</span><span class="p">(</span><span class="n">fit</span><span class="p">,</span> <span class="n">max_m_dist</span><span class="p">,</span> <span class="n">metric</span><span class="o">=</span><span class="s1">&#39;mahalanobis&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">fit</span></div>

<div class="viewcode-block" id="PCA.scale_vec"><a class="viewcode-back" href="../../python_shape_stats.html#python_shape_stats.statistical_shape_models.PCA.scale_vec">[docs]</a>    <span class="k">def</span> <span class="nf">scale_vec</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">target_dist</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">origin</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                  <span class="n">metric</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;euclidean&#39;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Scales vectors in the transformed space to be the target distance from the origin</span>

<span class="sd">        :param x: a k (observations) x self.n_dim matrix of locations in the transformed space. This can also be a vector of length self.n_dim</span>
<span class="sd">        :param target_dist: the target distance from the origin - this can be a single float or a vector entries corresponding to the rows of x</span>
<span class="sd">        :param origin: the origin with respect to which to scale the vectors</span>
<span class="sd">        :param metric: the distance metric (can be &#39;mahalanobis&#39; or &#39;euclidean&#39;</span>
<span class="sd">        :return: the scaled vectors in a matrix the same size as x</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">helpers</span><span class="o">.</span><span class="n">reshape_vector</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="s1">&#39;row&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">origin</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">origin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">eig_val</span><span class="p">)</span>
        <span class="n">x0</span> <span class="o">=</span> <span class="n">x</span> <span class="o">-</span> <span class="n">origin</span>
        <span class="c1"># use default origin as x0 is already centered</span>
        <span class="n">d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_distance</span><span class="p">(</span><span class="n">x0</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">metric</span><span class="o">=</span><span class="n">metric</span><span class="p">)</span>
        <span class="n">sc</span> <span class="o">=</span> <span class="n">d</span> <span class="o">/</span> <span class="n">target_dist</span>
        <span class="k">return</span> <span class="n">x0</span> <span class="o">/</span> <span class="n">sc</span></div>

<div class="viewcode-block" id="PCA.maha_dist_to_p_value"><a class="viewcode-back" href="../../python_shape_stats.html#python_shape_stats.statistical_shape_models.PCA.maha_dist_to_p_value">[docs]</a>    <span class="k">def</span> <span class="nf">maha_dist_to_p_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">md</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span> <span class="o">|</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the probability  an observation as or more extreme than the given</span>
<span class="sd">        Mahalanobis distance from the origin</span>

<span class="sd">        :param md: the mahalanobis distance, can be a float or an array of floats</span>
<span class="sd">        :return: the p-values corresponding to the elements in md</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">chi2</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="n">md</span> <span class="o">**</span> <span class="mi">2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_dim</span><span class="p">)</span></div>

<div class="viewcode-block" id="PCA.p_value_maha_dist"><a class="viewcode-back" href="../../python_shape_stats.html#python_shape_stats.statistical_shape_models.PCA.p_value_maha_dist">[docs]</a>    <span class="k">def</span> <span class="nf">p_value_maha_dist</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">p</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the Mahalanobis distance for which the probability of an observation as or more extrem is equal to p</span>

<span class="sd">        :param p: the p value, can be a float or an array of floats</span>
<span class="sd">        :return: the Mahalanobis distance, corresponding to the elements in md</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">chi2</span><span class="o">.</span><span class="n">ppf</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">p</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_dim</span><span class="p">))</span></div>

<div class="viewcode-block" id="PCA.get_distance"><a class="viewcode-back" href="../../python_shape_stats.html#python_shape_stats.statistical_shape_models.PCA.get_distance">[docs]</a>    <span class="k">def</span> <span class="nf">get_distance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">origin</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">metric</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;euclidean&#39;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Gets the distance of x from the origin, in the space of the transformed variables</span>

<span class="sd">        :param x: a vector of length l or an array k (observations) x l. l == self.n_dim</span>
<span class="sd">        :param origin: a vector of length l or an array k (observations) x l. l == self.n_dim. If origin is a matrix each row of x is comapred to the corresponding row of origin</span>
<span class="sd">        :param metric: the distance metric to use, must either be &#39;euclidean&#39; or &#39;mahalanobis&#39;</span>
<span class="sd">        :return: an array containing the distances of each row of x from</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">origin</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">origin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">eig_val</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">helpers</span><span class="o">.</span><span class="n">reshape_vector</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="s1">&#39;row&#39;</span><span class="p">)</span>
        <span class="n">origin</span> <span class="o">=</span> <span class="n">helpers</span><span class="o">.</span><span class="n">reshape_vector</span><span class="p">(</span><span class="n">origin</span><span class="p">,</span> <span class="s1">&#39;row&#39;</span><span class="p">)</span>
        <span class="n">x0</span> <span class="o">=</span> <span class="n">x</span> <span class="o">-</span> <span class="n">origin</span>
        <span class="k">if</span> <span class="nb">str</span><span class="o">.</span><span class="n">lower</span><span class="p">(</span><span class="n">metric</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;euclidean&#39;</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">elif</span> <span class="nb">str</span><span class="o">.</span><span class="n">lower</span><span class="p">(</span><span class="n">metric</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;mahalanobis&#39;</span><span class="p">:</span>
            <span class="n">x0</span> <span class="o">/=</span> <span class="n">helpers</span><span class="o">.</span><span class="n">reshape_vector</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">eig_std</span><span class="p">,</span> <span class="s1">&#39;row&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Invalid distance type&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">x0</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="ShapePCA"><a class="viewcode-back" href="../../python_shape_stats.html#python_shape_stats.statistical_shape_models.ShapePCA">[docs]</a><span class="k">class</span> <span class="nc">ShapePCA</span><span class="p">(</span><span class="n">PCA</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Implements some additional properties and methods for doing principal components analysis on a sample of shapes</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_average_polydata</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_reference_polydata</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">average_polydata</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        A polydata object of the average shape</span>

<span class="sd">        :type: helpers.TriPolyData</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">center_vec</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_reference_polydata</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">helpers</span><span class="o">.</span><span class="n">TriPolyData</span><span class="p">(</span><span class="n">helpers</span><span class="o">.</span><span class="n">landmark_2d_to_3d</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">center_vec</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">_reference_polydata</span><span class="o">.</span><span class="n">faces</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">helpers</span><span class="o">.</span><span class="n">TriPolyData</span><span class="p">(</span><span class="n">helpers</span><span class="o">.</span><span class="n">landmark_2d_to_3d</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">center_vec</span><span class="p">))</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">reference_polydata</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This should be an example shape from your dataset.The reference polydata determines how the average_polydata in visualisation of the PCA model can be rendered.</span>
<span class="sd">        Specifically if the topology of the surface is known this should be kept in reference_polydata.faces</span>
<span class="sd">        The average and other shape visualisations can then be visualised as surfaces, not just points.</span>

<span class="sd">        :type: helpers.TriPolyData</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_reference_polydata</span>

    <span class="nd">@reference_polydata</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">reference_polydata</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">val</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">helpers</span><span class="o">.</span><span class="n">TriPolyData</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_reference_polydata</span> <span class="o">=</span> <span class="n">val</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Reference polydata should be an instance of helpers.TriPolyData&#39;</span><span class="p">)</span>

<div class="viewcode-block" id="ShapePCA.fit"><a class="viewcode-back" href="../../python_shape_stats.html#python_shape_stats.statistical_shape_models.ShapePCA.fit">[docs]</a>    <span class="k">def</span> <span class="nf">fit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">center</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">center_config</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Fits the PCA model to training data x - uses the singular value decomposition of (centered) x.</span>

<span class="sd">        :param x: an l (vertices/landmarks) x 3 dimensions x k (observations) array of homologous shapes</span>
<span class="sd">        :param center: if True x will be centered along the third dimension by center_config x  prior to the SVD</span>
<span class="sd">        :param center_config: if None the &#39;center_config&#39; defaults to np.mean(x,axis=2) and thus centers the landm,rks on their mean shapes</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">center</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">center_config</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">center_config</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
            <span class="n">center_vec</span> <span class="o">=</span> <span class="n">helpers</span><span class="o">.</span><span class="n">landmark_3d_to_2d</span><span class="p">(</span><span class="n">center_config</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">center_vec</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">helpers</span><span class="o">.</span><span class="n">landmark_3d_to_2d</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">center</span><span class="o">=</span><span class="n">center</span><span class="p">,</span> <span class="n">center_vec</span><span class="o">=</span><span class="n">center_vec</span><span class="p">,</span> <span class="n">standardize_cols</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></div>

<div class="viewcode-block" id="ShapePCA.transform"><a class="viewcode-back" href="../../python_shape_stats.html#python_shape_stats.statistical_shape_models.ShapePCA.transform">[docs]</a>    <span class="k">def</span> <span class="nf">transform</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">apply_procrustes_transform</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">procrustes_scale</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                  <span class="n">n_jobs</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Transforms the landmark configurations in x into the lower dimenisonal space of the PCA model.</span>

<span class="sd">        :param x: an l (vertices/landmarks) x 3 dimensions x k (observations) array of homologous shapes</span>
<span class="sd">        :param apply_procrustes_transform: if True each observation in x will be aligned first to the mean shape using the Procrustes transform. If false then the shapes must already be aligned to the mean shape before calling this function</span>
<span class="sd">        :param procrustes_scale: if apply_procrustes_transform is True then this will determine if the configuratioons are allowed to scale towards the mean shape</span>
<span class="sd">        :param n_jobs: the number of jobs to run in parallel (see joblib.Parallel documentation)</span>
<span class="sd">        :return: a tuple containing 1. a k observations x self.ndims array of coordinates in the lower dimensional space, 2. a list of the procrustes transformations applied to each  configuration</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>
        <span class="n">n_configs</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">apply_procrustes_transform</span><span class="p">:</span>
            <span class="n">r</span> <span class="o">=</span> <span class="n">joblib</span><span class="o">.</span><span class="n">Parallel</span><span class="p">(</span><span class="n">n_jobs</span><span class="o">=</span><span class="n">n_jobs</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">10</span><span class="p">)(</span>
                <span class="n">joblib</span><span class="o">.</span><span class="n">delayed</span><span class="p">(</span><span class="n">procrustes</span><span class="o">.</span><span class="n">conform_p_to_q</span><span class="p">)(</span><span class="n">x</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">i</span><span class="p">],</span> <span class="n">helpers</span><span class="o">.</span><span class="n">landmark_2d_to_3d</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">center_vec</span><span class="p">),</span>
                                                          <span class="n">scale</span><span class="o">=</span><span class="n">procrustes_scale</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_configs</span><span class="p">))</span>
            <span class="n">v</span><span class="p">,</span> <span class="n">t</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">r</span><span class="p">)</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">t</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">identity</span><span class="p">(</span><span class="mi">4</span><span class="p">)]</span> <span class="o">*</span> <span class="n">n_configs</span>  <span class="c1"># no transformation is the same as tranforming by an identity matrix</span>

        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">helpers</span><span class="o">.</span><span class="n">landmark_3d_to_2d</span><span class="p">(</span><span class="n">x</span><span class="p">)),</span> <span class="n">t</span></div>

<div class="viewcode-block" id="ShapePCA.fit_transform"><a class="viewcode-back" href="../../python_shape_stats.html#python_shape_stats.statistical_shape_models.ShapePCA.fit_transform">[docs]</a>    <span class="k">def</span> <span class="nf">fit_transform</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">center</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">center_config</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Fits the PCA model to training data in x and transforms it into the lower dimensional space</span>

<span class="sd">        :param x: an l (vertices/landmarks) x 3 dimensions x k (observations) array of homologous shapes</span>
<span class="sd">        :param center: if True x will be centered along the third dimension by center_config x  prior to the SVD</span>
<span class="sd">        :param center_config: if None the &#39;center_config&#39; defaults to np.mean(x,axis=2) and thus centers the landmarks on their mean shapes</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">center</span><span class="o">=</span><span class="n">center</span><span class="p">,</span> <span class="n">center_config</span><span class="o">=</span><span class="n">center_config</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_transformed_training_data</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">apply_procrustes_transform</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></div>

<div class="viewcode-block" id="ShapePCA.animate_pc"><a class="viewcode-back" href="../../python_shape_stats.html#python_shape_stats.statistical_shape_models.ShapePCA.animate_pc">[docs]</a>    <span class="k">def</span> <span class="nf">animate_pc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pc_num</span> <span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">max_sd</span> <span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span> <span class="n">n_frames</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;write_gif&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Makes an animation illustrating the shape change associated a specified PC</span>

<span class="sd">        :param pc_num: the PC to visualise</span>
<span class="sd">        :param max_sd: The shape will be morphed between -max_sd - max_sd standard deviations</span>
<span class="sd">        :param n_frames: the number of frames to render in the animation</span>
<span class="sd">        :param mode: if &#39;write_gif&#39; animation will be written to file, if NoneType it will not</span>
<span class="sd">        :param kwargs: see helpers.animate_vectors</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">helpers</span><span class="o">.</span><span class="n">my_is_iterable</span><span class="p">(</span><span class="n">pc_num</span><span class="p">):</span>
            <span class="n">pc_num</span><span class="o">=</span> <span class="p">[</span><span class="n">pc_num</span><span class="p">]</span>

        <span class="n">vec</span> <span class="o">=</span> <span class="p">[</span><span class="n">helpers</span><span class="o">.</span><span class="n">landmark_2d_to_3d</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">eig_vec</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">eig_std</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">pc_num</span><span class="p">]</span>
        <span class="n">frame_scalars</span> <span class="o">=</span> <span class="n">helpers</span><span class="o">.</span><span class="n">_generate_circular_sequence</span><span class="p">(</span><span class="n">max_sd</span><span class="p">,</span> <span class="o">-</span><span class="n">max_sd</span><span class="p">,</span> <span class="n">n_in_sequence</span><span class="o">=</span><span class="n">n_frames</span><span class="p">)</span>
        <span class="n">frame_scalars</span> <span class="o">=</span> <span class="p">[</span><span class="n">frame_scalars</span><span class="p">]</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">pc_num</span><span class="p">)</span>
        <span class="n">polydatas</span> <span class="o">=</span> <span class="p">[</span><span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">average_polydata</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">pc_num</span><span class="p">))]</span>

        <span class="c1"># set default values of some of the keyword arguments</span>
        <span class="n">file_name</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;file_name&#39;</span><span class="p">,</span> <span class="s1">&#39;PC_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">pc_num</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;[&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;]&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">,</span> <span class="s1">&#39;_&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">))</span>
        <span class="n">title</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;title&#39;</span><span class="p">,[</span><span class="s1">&#39;PC &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">pc_num</span><span class="p">])</span>
        <span class="c1"># make animation</span>
        <span class="n">helpers</span><span class="o">.</span><span class="n">animate_vectors</span><span class="p">(</span><span class="n">polydatas</span><span class="p">,</span> <span class="n">vec</span><span class="p">,</span> <span class="n">frame_scalars</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="n">mode</span><span class="p">,</span> <span class="n">file_name</span><span class="o">=</span><span class="n">file_name</span><span class="p">,</span><span class="n">title</span><span class="o">=</span><span class="n">title</span><span class="p">,</span>
                               <span class="n">off_screen</span><span class="o">=</span><span class="n">off_screen</span><span class="p">,</span><span class="n">same_coordinate_system</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>
<div class="viewcode-block" id="ShapePCA.colormap_pc"><a class="viewcode-back" href="../../python_shape_stats.html#python_shape_stats.statistical_shape_models.ShapePCA.colormap_pc">[docs]</a>    <span class="k">def</span> <span class="nf">colormap_pc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">pc_num</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Make colormaps of the pcs in pc_num</span>

<span class="sd">        :param pc_num: a single, or list of n pcs to plot</span>
<span class="sd">        :param kwargs: see helpers.plot_colormaps</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">helpers</span><span class="o">.</span><span class="n">my_is_iterable</span><span class="p">(</span><span class="n">pc_num</span><span class="p">):</span>
            <span class="n">pc_num</span> <span class="o">=</span> <span class="p">[</span><span class="n">pc_num</span><span class="p">]</span>

        <span class="n">file_name</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;file_name&#39;</span><span class="p">,</span> <span class="s1">&#39;PC_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">pc_num</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;[&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;]&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">,</span> <span class="s1">&#39;_&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">))</span>
        <span class="n">title</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;title&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;PC &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">pc_num</span><span class="p">])</span>
        <span class="n">direction</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;direction&#39;</span><span class="p">,</span><span class="s1">&#39;normal&#39;</span><span class="p">)</span>

        <span class="n">pd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">average_polydata</span>
        <span class="n">vec</span> <span class="o">=</span> <span class="p">[</span><span class="n">helpers</span><span class="o">.</span><span class="n">landmark_2d_to_3d</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">eig_vec</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">eig_std</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">pc_num</span><span class="p">]</span>

        <span class="n">point_scalars</span> <span class="o">=</span> <span class="n">helpers</span><span class="o">.</span><span class="n">_vecs_to_scalars</span><span class="p">(</span><span class="n">vec</span><span class="p">,</span><span class="n">direction</span><span class="o">=</span><span class="n">direction</span><span class="p">,</span> <span class="n">poly</span><span class="o">=</span><span class="n">pd</span><span class="p">)</span>

        <span class="n">helpers</span><span class="o">.</span><span class="n">plot_colormaps</span><span class="p">(</span><span class="n">pd</span><span class="p">,</span> <span class="n">point_scalars</span><span class="p">,</span> <span class="n">file_name</span><span class="o">=</span><span class="n">file_name</span><span class="p">,</span> <span class="n">title</span> <span class="o">=</span> <span class="n">title</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div></div>


<span class="k">def</span> <span class="nf">_eigen_value_plot</span><span class="p">(</span><span class="n">eig_vals</span><span class="p">,</span> <span class="n">eig_vals_label</span><span class="o">=</span><span class="s1">&#39;Eigenvalue Spectrum&#39;</span><span class="p">,</span> <span class="n">distr</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">distr_label</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">ci_level</span><span class="o">=</span><span class="mf">95.</span><span class="p">,</span>
                      <span class="n">threshold_level</span><span class="o">=</span><span class="mf">95.</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">xlabel</span><span class="o">=</span><span class="s1">&#39;PC&#39;</span><span class="p">,</span>
                      <span class="n">ylabel</span><span class="o">=</span><span class="s1">&#39;Explained</span><span class="se">\n</span><span class="s1">Variance&#39;</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">ax</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">()</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">eig_vals</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">eig_vals</span><span class="p">))</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">eig_vals</span><span class="p">,</span> <span class="s1">&#39;b+-&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">eig_vals_label</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">xlabel</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="n">xlabel</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">ylabel</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">ylabel</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">title</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">distr</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># get CIs and threshold level</span>
        <span class="n">pctiles</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">distr</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">ci_level</span><span class="p">,</span> <span class="n">threshold_level</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="c1"># plot a green filled region between the lower and upper CIs</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">pctiles</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:],</span> <span class="n">pctiles</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:],</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">.2</span><span class="p">,</span> <span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;g&#39;</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;g&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">distr_label</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">pctiles</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="p">:])</span>

        <span class="c1"># plot the specified threshold as a solid line</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">pctiles</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="p">:],</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;g&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Threshold&#39;</span><span class="p">)</span>

        <span class="c1"># find the first time that the explained variance is less than the threshold</span>
        <span class="n">inds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">less</span><span class="p">(</span><span class="n">eig_vals</span><span class="p">,</span> <span class="n">pctiles</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="p">:]))[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">inds</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
            <span class="n">n_comps</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">eig_vals</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">n_comps</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">inds</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">n_comps</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;:&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Estimated No. Comp.&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">n_comps</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">ax</span><span class="p">,</span> <span class="n">n_comps</span>


<div class="viewcode-block" id="PLS"><a class="viewcode-back" href="../../python_shape_stats.html#python_shape_stats.statistical_shape_models.PLS">[docs]</a><span class="k">class</span> <span class="nc">PLS</span><span class="p">(</span><span class="n">ABC</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    An abstract base class implementing properties and methods common to all classes implementing partial least-squares analyses</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_x</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_y</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_standardize_x</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_standardize_y</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_center_x</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_center_y</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_observation_mask</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_observation_weights</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_x_mu</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_y_mu</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_x_std</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_y_std</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">y</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The complete block of y variables, before exclusion mask or dummy variables are created as a pandas</span>
<span class="sd">        DataFrame. The y.setter, depending on the subclass, may take or expect an instance of</span>
<span class="sd">        :py:class:`PCA` or :py:class:`ShapePCA` in which case the getter will return the attribute</span>
<span class="sd">        :py:attr:`PCA.transformed_training_data`</span>
<span class="sd">        :type: pd.DataFrame</span>
<span class="sd">         &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_convert_to_data_frame</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_y</span><span class="p">)</span>

    <span class="nd">@y</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">y</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">val</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
            <span class="n">val</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_validate_data_frame</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_y</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">x</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The complete block of x variables, before exclusion mask or dummy variables are created as a pandas</span>
<span class="sd">        DataFrame. The x.setter, depending on the subclass, may take or expect an instance of</span>
<span class="sd">        :py:class:`PCA` or :py:class:`ShapePCA` in which case the getter will return the attribute</span>
<span class="sd">        :py:attr:`PCA.transformed_training_data`</span>

<span class="sd">        :type: pd.DataFrame</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_convert_to_data_frame</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_x</span><span class="p">)</span>

    <span class="nd">@x</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">x</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">val</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
            <span class="n">val</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_validate_data_frame</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_x</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">__n_obs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;hidden property keeping track of how many subjects are in the x block, before exclusion criteria are applied&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">center_x</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Indicates whether or not the x-block is to be column centered. Is intended to be set only via a call to the &#39;fit&#39; method of the class</span>

<span class="sd">        :type: bool</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_center_x</span>

    <span class="c1"># @center_x.setter</span>
    <span class="c1"># def center_x(self,val):</span>
    <span class="c1">#     self._center_x = val</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">center_y</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Indicates whether or not the y-block is to be column-centered. Is intended to be set only via a call to the &#39;fit&#39; method of the class</span>

<span class="sd">        :type: bool</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_center_y</span>

    <span class="c1"># @center_y.setter</span>
    <span class="c1"># def center_y(self,val):</span>
    <span class="c1">#     self._center_y = val</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">standardize_x</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Indicates whether or not the x-block is to be column standardized to have unit variance. Is intended to be set only via a call to the &#39;fit&#39; method of the class</span>

<span class="sd">        :type: bool</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_standardize_x</span>

    <span class="c1"># @standardize_x.setter</span>
    <span class="c1"># def standardize_x(self,val):</span>
    <span class="c1">#     self._standardize_x = val</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">standardize_y</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Indicates whether or not the x-block is to be column standardized to have unit variance. Is intended to be set only via a call to the &#39;fit&#39; method of the class</span>

<span class="sd">        :type: bool</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_standardize_y</span>


    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">n_obs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Number of observations after exclusion mask have been applied</span>

<span class="sd">        :type: int</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">observation_mask</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="nb">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">observation_mask</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">x_treated</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The block of x variables  after categorical variables are expanded to dummy variables</span>
<span class="sd">        and exclusion mask has been applied. If no categorical variables are in self.x and no</span>
<span class="sd">        observation mask has been applied then this is the same as self.x cast into a DataFrame</span>

<span class="sd">        :type: pd.DataFrame</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_treat_var_block</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">observation_mask</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_are_categories_possible</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_x</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">y_treated</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The block of y variables  after categorical variables are expanded to dummy variables</span>
<span class="sd">        and exclusion mask has been applied. If no categorical variables are in self.y and no</span>
<span class="sd">        observation mask has been applied then this is the same as self.y</span>

<span class="sd">        :type: pd.DataFrame</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_treat_var_block</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">observation_mask</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_are_categories_possible</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_y</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">_y_block_var_indices</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_y</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_treat_var_block</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">observation_mask</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_are_categories_possible</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_y</span><span class="p">))[</span><span class="mi">1</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">_x_block_var_indices</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_x</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_treat_var_block</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">observation_mask</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_are_categories_possible</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_x</span><span class="p">))[</span><span class="mi">1</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">_xblock_data_types</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This is potentially confusing...if there are no categorical variables in x or there is no exclusion mask set</span>
<span class="sd">        then this is identical to self.x.dtypes, if there is both an observation mask set and some categorical variables</span>
<span class="sd">        then the pd.CategoricalDtype objects of x.dtypes are &#39;squeezed&#39; to remove reference that are not present</span>
<span class="sd">        after removing the relevant observations</span>

<span class="sd">        :type: pd.Series</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_observation_mask</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="o">.</span><span class="n">dtypes</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">helpers</span><span class="o">.</span><span class="n">squeeze_categorical_dtypes</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">observation_mask</span><span class="p">])</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">_yblock_data_types</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This is potentially confusing...if there are no categorical variables in x or there is no exclusion mask set</span>
<span class="sd">        then this is identical to self.y.dtypes, if there is both an observation mask set and some categorical variables</span>
<span class="sd">        then the pd.CategoricalDtype objects of y.dtypes are &#39;squeezed&#39; to remove reference that are not present</span>
<span class="sd">        after removing the relevant observations</span>

<span class="sd">        :type: pd.Series</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_observation_mask</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="o">.</span><span class="n">dtypes</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">helpers</span><span class="o">.</span><span class="n">squeeze_categorical_dtypes</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_observation_mask</span><span class="p">])</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">_x0</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">x</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="n">x0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">x_treated</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">center_x</span><span class="p">:</span>
            <span class="n">x0</span> <span class="o">=</span> <span class="n">x0</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">x_mu</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">standardize_x</span><span class="p">:</span>
            <span class="n">x0</span> <span class="o">=</span> <span class="n">x0</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">x_std</span>
        <span class="n">x0</span> <span class="o">*=</span> <span class="bp">self</span><span class="o">.</span><span class="n">observation_weights</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">observation_mask</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">x0</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">_y0</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">y0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_2d</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">y_treated</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">))</span>
        <span class="n">y0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_center_scale_y</span><span class="p">(</span><span class="n">y0</span><span class="p">,</span><span class="n">reverse</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">y0</span> <span class="o">*=</span> <span class="bp">self</span><span class="o">.</span><span class="n">observation_weights</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">observation_mask</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">y0</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">observation_weights</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        A vector of weights (one for each observation) that control the influence of each observation on the fitted model</span>

<span class="sd">        :type: np.ndarray</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_observation_weights</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_x</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">None</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__n_obs</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_observation_weights</span><span class="p">)</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__n_obs</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;observation weights should be the same length as the number of observations&#39;</span><span class="p">)</span>

            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_observation_weights</span>

    <span class="nd">@observation_weights</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">observation_weights</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">val</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_observation_weights</span> <span class="o">=</span> <span class="n">val</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">observation_mask</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        A boolean vector that can be used to control the observations that are included in fitting the model.</span>
<span class="sd">        Each element corresponds to an observation (row of x and y). If the value is true then that observation will be included</span>
<span class="sd">        otherwise it won&#39;t be.</span>

<span class="sd">        :type: np.ndarray</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_observation_mask</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_x</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">None</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__n_obs</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># check is the same size as x</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_x</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_observation_mask</span><span class="p">)</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__n_obs</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;observation mask should be the same length as the number of observations&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_observation_mask</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>

    <span class="nd">@observation_mask</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">observation_mask</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">val</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;observation maks should be an numpy.ndarray&#39;</span><span class="p">)</span>
        <span class="n">val</span> <span class="o">=</span> <span class="n">val</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_observation_mask</span> <span class="o">=</span> <span class="n">val</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">no_y_features</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The number of features/variables (columns) of the y-block before categorical variables are expanded to dummy variables</span>

<span class="sd">        :type: int</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_y0</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_y0</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">no_x_features</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The number of features/variables (columns) of the x-block before categorical variables are expanded to dummy variables</span>

<span class="sd">        :type: int</span>
<span class="sd">            &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_x0</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_x0</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">x_mu</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The (weighted) column means of x after categorical variables are expanded to dummy variables and after the observation mask has been applied</span>

<span class="sd">        :type: np.ndarray</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_x_mu</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># if the mean has not been otherwise explicitly set</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">x_treated</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">None</span>
            <span class="k">return</span> <span class="n">helpers</span><span class="o">.</span><span class="n">weighted_column_mean</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x_treated</span><span class="p">,</span>
                                                <span class="bp">self</span><span class="o">.</span><span class="n">observation_weights</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">observation_mask</span><span class="p">])</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_x_mu</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">x_std</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The (weighted) column standard deviations of x after categorical variables are expanded to dummy variables and after the observation mask has been applied</span>

<span class="sd">        :type: np.ndarray</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_x_std</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">x</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">None</span>
            <span class="n">x0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">x_treated</span>
            <span class="n">w</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">observation_weights</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">observation_mask</span><span class="p">]</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">center_x</span><span class="p">:</span>
                <span class="n">x0</span> <span class="o">=</span> <span class="n">x0</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">x_mu</span>
            <span class="k">return</span> <span class="n">helpers</span><span class="o">.</span><span class="n">weighted_rms</span><span class="p">(</span><span class="n">x0</span><span class="p">,</span> <span class="n">w</span><span class="p">)</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_x_std</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">y_mu</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The (weighted) column means of y after categorical variables are expanded to dummy variables and after the observation mask has been applied</span>

<span class="sd">        :type: np.ndarray</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_y_mu</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># if the mean has not been otherwise explicitly set</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">y_treated</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">None</span>
            <span class="k">return</span> <span class="n">helpers</span><span class="o">.</span><span class="n">weighted_column_mean</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">y_treated</span><span class="p">,</span>
                                                <span class="bp">self</span><span class="o">.</span><span class="n">observation_weights</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">observation_mask</span><span class="p">])</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_y_mu</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">y_std</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The (weighted) column standard deviations of x after categorical variables are expanded to dummy variables and after the observation mask has been applied</span>

<span class="sd">        :type: np.ndarray</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_y_std</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">y_treated</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">None</span>
            <span class="n">y0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">y_treated</span>  <span class="c1"># [self.observation_mask, :]</span>
            <span class="n">w</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">observation_weights</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">observation_mask</span><span class="p">]</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">center_y</span><span class="p">:</span>
                <span class="n">y0</span> <span class="o">=</span> <span class="n">y0</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">y_mu</span>
            <span class="k">return</span> <span class="n">helpers</span><span class="o">.</span><span class="n">weighted_rms</span><span class="p">(</span><span class="n">y0</span><span class="p">,</span> <span class="n">w</span><span class="p">)</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>

            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_y_std</span>

    <span class="k">def</span> <span class="nf">_center_scale_x</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">x</span><span class="p">,</span><span class="n">reverse</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
       <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_center_scale</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">x_mu</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">x_std</span><span class="p">,</span><span class="n">scale</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">standardize_x</span><span class="p">,</span><span class="n">center</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">standardize_x</span><span class="p">,</span><span class="n">reverse</span><span class="o">=</span><span class="n">reverse</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_center_scale_y</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_center_scale</span><span class="p">(</span><span class="n">y</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">y_mu</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">y_std</span><span class="p">,</span><span class="n">scale</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">standardize_y</span><span class="p">,</span><span class="n">center</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">center_y</span><span class="p">,</span><span class="n">reverse</span><span class="o">=</span><span class="n">reverse</span><span class="p">)</span>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_center_scale</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">mu</span><span class="p">,</span><span class="n">std</span><span class="p">,</span><span class="n">scale</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">center</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">reverse</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">reverse</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">center</span><span class="p">:</span>
                <span class="n">x</span><span class="o">-=</span><span class="n">mu</span>
            <span class="k">if</span> <span class="n">scale</span><span class="p">:</span>
                <span class="n">x</span> <span class="o">/=</span><span class="n">std</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">scale</span><span class="p">:</span>
                <span class="n">x</span><span class="o">*=</span><span class="n">std</span>
            <span class="k">if</span> <span class="n">center</span><span class="p">:</span>
                <span class="n">x</span><span class="o">+=</span><span class="n">mu</span>
        <span class="k">return</span> <span class="n">x</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_treat_var_block</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="n">search_for_cats</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span>
                          <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>  <span class="c1"># it is expected that an end user will not be able to reach this error, this error indicates a bug</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;Expected pandas.DataFrame&#39;</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>
        <span class="n">x</span><span class="p">,</span> <span class="n">indices</span> <span class="o">=</span> <span class="n">PLS</span><span class="o">.</span><span class="n">_expand_block</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">x</span><span class="o">.</span><span class="n">dtypes</span><span class="p">,</span> <span class="n">search_for_categories</span><span class="o">=</span><span class="n">search_for_cats</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">x</span><span class="p">,</span> <span class="n">indices</span><span class="p">,</span> <span class="n">helpers</span><span class="o">.</span><span class="n">squeeze_categorical_dtypes</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_are_categories_possible</span><span class="p">(</span><span class="n">in_</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">in_</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_convert_to_data_frame</span><span class="p">(</span><span class="n">in_</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">in_</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">in_</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">in_</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">in_</span><span class="p">,</span> <span class="n">PCA</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">in_</span><span class="o">.</span><span class="n">transformed_training_data</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">in_</span><span class="p">,</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">)):</span>
            <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">in_</span><span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_expand_block</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">dtypes</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">search_for_categories</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;Expected a pandas data frame&#39;</span><span class="p">)</span>
        <span class="c1"># check if any categorical variables in dtypes</span>
        <span class="n">is_cat</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">item</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;category&#39;</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">dtypes</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">equal</span><span class="p">(</span><span class="n">is_cat</span><span class="p">,</span> <span class="kc">False</span><span class="p">))</span> <span class="o">|</span> <span class="p">(</span><span class="ow">not</span> <span class="n">search_for_categories</span><span class="p">):</span>  <span class="c1"># no expansion to be done</span>
            <span class="k">return</span> <span class="n">x</span><span class="p">,</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])]</span>
        <span class="n">x_chunks</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">block_indices</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
            <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">dtypes</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">col</span><span class="p">])</span> <span class="o">==</span> <span class="s1">&#39;category&#39;</span><span class="p">:</span>
                <span class="n">dum</span> <span class="o">=</span> <span class="n">helpers</span><span class="o">.</span><span class="n">get_dummy</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="n">col</span><span class="p">],</span> <span class="n">x</span><span class="o">.</span><span class="n">dtypes</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">col</span><span class="p">])</span>
                <span class="n">x_chunks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dum</span><span class="p">)</span>
                <span class="n">block_indices</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">col</span><span class="p">]</span> <span class="o">*</span> <span class="n">dum</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">x_chunks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="n">col</span><span class="p">])</span>
                <span class="n">block_indices</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">col</span><span class="p">])</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">x_chunks</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">x</span><span class="p">,</span> <span class="n">block_indices</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_validate_data_frame</span><span class="p">(</span><span class="n">val</span><span class="p">):</span>
        <span class="c1"># check all columns are unique</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">val</span><span class="o">.</span><span class="n">columns</span><span class="p">))</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">val</span><span class="o">.</span><span class="n">columns</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;All columns of the data frame should have unique headers&#39;</span><span class="p">)</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
        <span class="n">out</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">item</span><span class="p">)</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">val</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">out</span>

<div class="viewcode-block" id="PLS.fit"><a class="viewcode-back" href="../../python_shape_stats.html#python_shape_stats.statistical_shape_models.PLS.fit">[docs]</a>    <span class="nd">@abstractmethod</span>
    <span class="k">def</span> <span class="nf">fit</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="o">...</span></div></div>


<div class="viewcode-block" id="PLS_2B"><a class="viewcode-back" href="../../python_shape_stats.html#python_shape_stats.statistical_shape_models.PLS_2B">[docs]</a><span class="k">class</span> <span class="nc">PLS_2B</span><span class="p">(</span><span class="n">PLS</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Performs a symmetrical 2-block PLS via singular value decomposition of the cross-covariance matrix C</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># :math:`C = X0^T \\cdot Y0` where X0 and Y0 are two n (observations) by k (x features) or q (y features) matrices.</span>
    <span class="c1"># These matrices are usually column mean-centered and optionally standardised so that column variance is equal to 1.</span>
    <span class="c1"># The singular value decomposition yields</span>
    <span class="c1">#</span>
    <span class="c1"># :math: `USV^T = C`</span>
    <span class="c1">#</span>
    <span class="c1"># where the ith column of U and V</span>




    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_x_projection_matrix</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_y_projection_matrix</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cov_explained</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_x_scores</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_y_scores</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_permutation_null_distribution</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_inner_relation_coefs</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">x_projection_matrix</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        An orthogonal projection matrix onto the lower-dimensional space of the x-scares.</span>
<span class="sd">        Rows correspond to the features (columns) in the x-block, columns correspond to the PLS dimensions.</span>

<span class="sd">        :type: np.ndarray</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_x_projection_matrix</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">y_projection_matrix</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        An orthogonal projection matrix onto the lower-dimensional space of the y-scares.</span>
<span class="sd">        Rows correspond to the features (columns) in the y-block, columns correspond to the PLS dimensions.</span>

<span class="sd">        :type: np.ndarray</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_y_projection_matrix</span>


    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">cov_explained</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The amount of covariance explained by each latent dimension</span>

<span class="sd">        :type: np.ndarray</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cov_explained</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">x_scores</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The observations in the x-block represented in the lower-dimensional space.</span>
<span class="sd">        Rows correspond to observations, columns to dimensions.</span>

<span class="sd">        :type: np.ndarray</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_x_scores</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">y_scores</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The observations in the y-block represented in the lower-dimensional space.</span>
<span class="sd">        Rows correspond to observations, columns to dimensions.</span>

<span class="sd">        :type: np.ndarray</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_y_scores</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">n_dim</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The number of latent dimensions in the model</span>

<span class="sd">        :type: int</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cov_explained</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cov_explained</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">inner_relation_coefs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Coefficients modelling the relationship between the x-scores and the y scores.</span>
<span class="sd">        Each coefficient corresponds to a pair of dimensions. The ith coefficient is the coefficient of a major axis regression of self.y_scores[:,i] onto self.x_scores[:,i]</span>

<span class="sd">        :type: np.ndarray</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_inner_relation_coefs</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">perm_test_p_values</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        P values corresponding to each latent dimension. :py:meth:`PLS_2B.compute_null_distribution` before accessing this property</span>

<span class="sd">        :type: np.ndarray</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_permutation_null_distribution</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">_permutation_null_distribution</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">cov_explained</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,:])</span><span class="o">&gt;=</span><span class="mi">0</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">_permutation_null_distribution</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

<div class="viewcode-block" id="PLS_2B.transform_x"><a class="viewcode-back" href="../../python_shape_stats.html#python_shape_stats.statistical_shape_models.PLS_2B.transform_x">[docs]</a>    <span class="k">def</span> <span class="nf">transform_x</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span> <span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">|</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">expand_categories</span> <span class="p">:</span> <span class="nb">bool</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Performs the dimension reduction on x. If expand_categories == True the function will search for categorical variables in x</span>
<span class="sd">        and expand them into dummy variables.</span>

<span class="sd">        :param x: an n (observations) by k (number of x features) np.ndarrdy or pd.DataFrame. If expand_categories==True, this must be a DataFrame</span>
<span class="sd">        :param expand categories: whether to search for categoricakl variables in x and expand them into dummy variables.</span>

<span class="sd">        :return: np.ndarray</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">expand_categories</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;when </span><span class="se">\&#39;</span><span class="s1">expand_categories</span><span class="se">\&#39;</span><span class="s1">==True x is expected to be a pandas data frame&#39;</span><span class="p">)</span>
                <span class="c1"># convert categorical data to dummy coded data if present</span>
                <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_expand_block</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">dtypes</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_xblock_data_types</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">)):</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">center_x</span><span class="p">:</span>
            <span class="n">x</span> <span class="o">-=</span> <span class="bp">self</span><span class="o">.</span><span class="n">x_mu</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">standardize_x</span><span class="p">:</span>
            <span class="n">x</span> <span class="o">/=</span> <span class="bp">self</span><span class="o">.</span><span class="n">x_std</span>

        <span class="k">return</span> <span class="n">x</span> <span class="o">@</span> <span class="bp">self</span><span class="o">.</span><span class="n">x_projection_matrix</span></div>

<div class="viewcode-block" id="PLS_2B.transform_y"><a class="viewcode-back" href="../../python_shape_stats.html#python_shape_stats.statistical_shape_models.PLS_2B.transform_y">[docs]</a>    <span class="k">def</span> <span class="nf">transform_y</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">y</span> <span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">|</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span> <span class="p">,</span> <span class="n">expand_categories</span><span class="p">:</span><span class="nb">bool</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Performs the dimension reduction on y. If expand_categories == True the function will search for categorical variables in x</span>
<span class="sd">        and expand them into dummy variables.</span>

<span class="sd">        :param x: an n (observations) by k (number of x features) np.ndarrdy or pd.DataFrame. If expand_categories==True, this must be a DataFrame</span>
<span class="sd">        :param expand categories: whether to search for categoricakl variables in x and expand them into dummy variables.</span>

<span class="sd">        :return: np.ndarray</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">expand_categories</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;when </span><span class="se">\&#39;</span><span class="s1">expand_categories</span><span class="se">\&#39;</span><span class="s1">==True x is expected to be a pandas data frame&#39;</span><span class="p">)</span>
                <span class="c1"># convert categorical data to dummy coded data if present</span>
                <span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_expand_block</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">dtypes</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_yblock_data_types</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">)):</span>
            <span class="n">y</span> <span class="o">=</span> <span class="n">y</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">center_y</span><span class="p">:</span>
            <span class="n">y</span> <span class="o">-=</span> <span class="bp">self</span><span class="o">.</span><span class="n">y_mu</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">standardize_y</span><span class="p">:</span>
            <span class="n">y</span> <span class="o">/=</span> <span class="bp">self</span><span class="o">.</span><span class="n">y_std</span>
        <span class="k">return</span> <span class="n">y</span> <span class="o">@</span> <span class="bp">self</span><span class="o">.</span><span class="n">y_projection_matrix</span></div>



<div class="viewcode-block" id="PLS_2B.fit"><a class="viewcode-back" href="../../python_shape_stats.html#python_shape_stats.statistical_shape_models.PLS_2B.fit">[docs]</a>    <span class="k">def</span> <span class="nf">fit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span> <span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">|</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span> <span class="o">|</span> <span class="n">ShapePCA</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">|</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span> <span class="o">|</span> <span class="n">ShapePCA</span><span class="p">,</span> <span class="n">center_x</span><span class="p">:</span><span class="nb">bool</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">center_y</span><span class="p">:</span><span class="nb">bool</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">standardize_x</span><span class="p">:</span><span class="nb">bool</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">standardize_y</span><span class="p">:</span><span class="nb">bool</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">observation_weights</span><span class="p">:</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">observation_mask</span><span class="p">:</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Fits the two block PLS model to the data x and y</span>

<span class="sd">        :param x: the x-block of variables. This can be an n (observations) by k features np.ndarray or pd.DataFrame. It can also be an instance of :py:class:`PCA` or one of its subclasses. If it is an np.ndarray this simply becomes the x block. If it is a DataFrame, each column&#39;s dtype is checked if dtype==&#39;category&#39; these will be expanded to l-1 dummy variables, where l is the number of unique values in the column. If it is a :py:class:`PCA` (or a subclass thereof) the x block will be the PC scores :py:attr:`PCA.transformed_training_data`</span>
<span class="sd">        :param y: the y-block of variables. The same details apply as for &#39;x&#39;</span>
<span class="sd">        :param center_x: boolean indicating whether to column mean center x</span>
<span class="sd">        :param center_y: boolean indicating whether to column mean center y</span>
<span class="sd">        :param standardize_x: boolean indicating whether to standardize the columns of x to have unit variance</span>
<span class="sd">        :param standardize_y:boolean indicating whether to standardize the columns of y to have unit variance</span>
<span class="sd">        :param observation_weights: a vector of length n (observations)</span>
<span class="sd">        :param observation_mask: a boolean array of length n (observations)</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_center_x</span> <span class="o">=</span> <span class="n">center_x</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_center_y</span> <span class="o">=</span> <span class="n">center_y</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_standardize_x</span> <span class="o">=</span> <span class="n">standardize_x</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_standardize_y</span> <span class="o">=</span> <span class="n">standardize_y</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_observation_mask</span> <span class="o">=</span> <span class="n">observation_mask</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_observation_weights</span> <span class="o">=</span> <span class="n">observation_weights</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="n">x</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">y</span> <span class="o">=</span> <span class="n">y</span>
        <span class="c1"># do the svd</span>
        <span class="n">cov</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_x0</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="bp">self</span><span class="o">.</span><span class="n">_y0</span>
        <span class="n">rank_upper_bound</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_x_projection_matrix</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_y_projection_matrix</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cov_explained</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_do_svd</span><span class="p">(</span><span class="n">cov</span><span class="p">,</span>
                                                                                                   <span class="bp">self</span><span class="o">.</span><span class="n">observation_weights</span><span class="p">,</span>
                                                                                                   <span class="n">rank_upper_bound</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_x_scores</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">transform_x</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x_treated</span><span class="p">,</span> <span class="n">expand_categories</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_y_scores</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">transform_y</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">y_treated</span><span class="p">,</span> <span class="n">expand_categories</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_inner_relation_coefs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fit_inner_relation</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x_scores</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y_scores</span><span class="p">,</span>
                                                             <span class="bp">self</span><span class="o">.</span><span class="n">observation_weights</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">observation_mask</span><span class="p">])</span></div>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_do_svd</span><span class="p">(</span><span class="n">cov</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">n_comps</span><span class="p">):</span>
        <span class="p">[</span><span class="n">u</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">v</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">svd</span><span class="p">(</span><span class="n">cov</span><span class="p">)</span>
        <span class="n">u</span> <span class="o">=</span> <span class="n">u</span><span class="p">[:,</span> <span class="p">:</span><span class="n">n_comps</span><span class="p">]</span>
        <span class="n">v</span> <span class="o">=</span> <span class="n">v</span><span class="p">[:</span><span class="n">n_comps</span><span class="p">]</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">s</span><span class="p">[:</span><span class="n">n_comps</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="p">(</span><span class="n">s</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="nb">sum</span><span class="p">(</span><span class="n">w</span><span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_fit_inner_relation</span><span class="p">(</span><span class="n">x_scores</span><span class="p">,</span> <span class="n">y_scores</span><span class="p">,</span> <span class="n">weights</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Fits the inner model between the x scores and the y scores. The relationship between each pair of latent variables self.xscores[:,i] self.y_scores[:,i]</span>
<span class="sd">        as a symmetrical (major axis) regression</span>

<span class="sd">        :return: coefs</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">n_obs</span><span class="p">,</span> <span class="n">n_dims</span> <span class="o">=</span> <span class="n">x_scores</span><span class="o">.</span><span class="n">shape</span>
        <span class="n">coefs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n_dims</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_dims</span><span class="p">):</span>
            <span class="n">xy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">atleast_2d</span><span class="p">(</span><span class="n">x_scores</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]),</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_2d</span><span class="p">(</span><span class="n">y_scores</span><span class="p">[:,</span> <span class="n">i</span><span class="p">])],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">cov</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cov</span><span class="p">(</span><span class="n">xy</span><span class="p">,</span> <span class="n">aweights</span><span class="o">=</span><span class="n">weights</span><span class="p">,</span> <span class="n">rowvar</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">w</span><span class="p">,</span> <span class="n">v</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">eigh</span><span class="p">(</span><span class="n">cov</span><span class="p">)</span>
            <span class="n">vec</span> <span class="o">=</span> <span class="n">v</span><span class="p">[:,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">coefs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">vec</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="n">vec</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">coefs</span>

<div class="viewcode-block" id="PLS_2B.reconstruct_y_from_scores"><a class="viewcode-back" href="../../python_shape_stats.html#python_shape_stats.statistical_shape_models.PLS_2B.reconstruct_y_from_scores">[docs]</a>    <span class="k">def</span> <span class="nf">reconstruct_y_from_scores</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">y_scores</span><span class="p">):</span>
        <span class="n">y0</span> <span class="o">=</span> <span class="n">y_scores</span> <span class="o">@</span> <span class="bp">self</span><span class="o">.</span><span class="n">_y_projection_matrix</span>
        <span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_center_scale_y</span><span class="p">(</span><span class="n">y0</span><span class="p">,</span><span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">y</span></div>

<div class="viewcode-block" id="PLS_2B.reconstruct_x_from_scores"><a class="viewcode-back" href="../../python_shape_stats.html#python_shape_stats.statistical_shape_models.PLS_2B.reconstruct_x_from_scores">[docs]</a>    <span class="k">def</span> <span class="nf">reconstruct_x_from_scores</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x_scores</span><span class="p">):</span>
        <span class="n">x0</span> <span class="o">=</span> <span class="n">x_scores</span> <span class="o">@</span> <span class="bp">self</span><span class="o">.</span><span class="n">_x_projection_matrix</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_center_scale_x</span><span class="p">(</span><span class="n">x0</span><span class="p">,</span><span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">x</span></div>

<div class="viewcode-block" id="PLS_2B.predict_y_scores_from_x"><a class="viewcode-back" href="../../python_shape_stats.html#python_shape_stats.statistical_shape_models.PLS_2B.predict_y_scores_from_x">[docs]</a>    <span class="k">def</span> <span class="nf">predict_y_scores_from_x</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x_scores</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">x_scores</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">inner_relation_coefs</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:]</span></div>

<div class="viewcode-block" id="PLS_2B.predict_x_scores_from_y"><a class="viewcode-back" href="../../python_shape_stats.html#python_shape_stats.statistical_shape_models.PLS_2B.predict_x_scores_from_y">[docs]</a>    <span class="k">def</span> <span class="nf">predict_x_scores_from_y</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">y_scores</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">y_scores</span> <span class="o">*</span> <span class="mi">1</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">inner_relation_coefs</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:]</span></div>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_perm_test_one_iter</span><span class="p">(</span><span class="n">x0</span><span class="p">,</span> <span class="n">y0</span><span class="p">,</span> <span class="n">weights</span><span class="p">,</span> <span class="n">n_comps</span><span class="p">,</span> <span class="n">seed</span><span class="p">):</span>
        <span class="n">rng</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">default_rng</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>
        <span class="n">n_obs</span> <span class="o">=</span> <span class="n">x0</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="c1"># permute rows of x</span>
        <span class="n">x0</span> <span class="o">=</span> <span class="n">x0</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">x0</span> <span class="o">=</span> <span class="n">x0</span><span class="p">[</span><span class="n">rng</span><span class="o">.</span><span class="n">permutation</span><span class="p">(</span><span class="n">n_obs</span><span class="p">),</span> <span class="p">:]</span>
        <span class="n">cov</span> <span class="o">=</span> <span class="n">x0</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">y0</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">s</span> <span class="o">=</span> <span class="n">PLS_2B</span><span class="o">.</span><span class="n">_do_svd</span><span class="p">(</span><span class="n">cov</span><span class="p">,</span> <span class="n">weights</span><span class="p">,</span> <span class="n">n_comps</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">s</span>

<div class="viewcode-block" id="PLS_2B.compute_null_distribution"><a class="viewcode-back" href="../../python_shape_stats.html#python_shape_stats.statistical_shape_models.PLS_2B.compute_null_distribution">[docs]</a>    <span class="k">def</span> <span class="nf">compute_null_distribution</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n_reps</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="n">n_jobs</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">rng</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">default_rng</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>
        <span class="n">ss</span> <span class="o">=</span> <span class="n">rng</span><span class="o">.</span><span class="n">bit_generator</span><span class="o">.</span><span class="n">_seed_seq</span>
        <span class="n">child_states</span> <span class="o">=</span> <span class="n">ss</span><span class="o">.</span><span class="n">spawn</span><span class="p">(</span><span class="n">n_reps</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">joblib_progress</span><span class="p">(</span><span class="s1">&#39;Running permutation test...&#39;</span><span class="p">,</span> <span class="n">n_reps</span><span class="p">):</span>
            <span class="n">args</span> <span class="o">=</span> <span class="n">joblib</span><span class="o">.</span><span class="n">Parallel</span><span class="p">(</span><span class="n">n_jobs</span><span class="o">=</span><span class="n">n_jobs</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">)(</span>
                <span class="n">joblib</span><span class="o">.</span><span class="n">delayed</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_perm_test_one_iter</span><span class="p">)(</span><span class="bp">self</span><span class="o">.</span><span class="n">_x0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_y0</span><span class="p">,</span>
                                                         <span class="bp">self</span><span class="o">.</span><span class="n">observation_weights</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">observation_mask</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_dim</span><span class="p">,</span>
                                                         <span class="n">child_states</span><span class="p">[</span><span class="n">x</span><span class="p">])</span>
                <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_reps</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_permutation_null_distribution</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">(</span><span class="n">args</span><span class="p">)</span></div>

<div class="viewcode-block" id="PLS_2B.permutation_test_plot"><a class="viewcode-back" href="../../python_shape_stats.html#python_shape_stats.statistical_shape_models.PLS_2B.permutation_test_plot">[docs]</a>    <span class="k">def</span> <span class="nf">permutation_test_plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">p_crit</span><span class="o">=</span><span class="mf">.05</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">recompute_null_distribution</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">n_reps</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                              <span class="n">n_jobs</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="n">CIpct</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">p_crit</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span>

        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_permutation_null_distribution</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="o">|</span> <span class="n">recompute_null_distribution</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">compute_null_distributions</span><span class="p">(</span><span class="n">n_reps</span><span class="o">=</span><span class="n">n_reps</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="n">seed</span><span class="p">,</span> <span class="n">n_jobs</span><span class="o">=</span><span class="n">n_jobs</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">_eigen_value_plot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cov_explained</span><span class="p">,</span> <span class="n">eig_vals_label</span><span class="o">=</span><span class="s1">&#39;Covariance Explained&#39;</span><span class="p">,</span>
                          <span class="n">distr</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_permutation_null_distribution</span><span class="p">,</span> <span class="n">distr_label</span><span class="o">=</span><span class="s1">&#39;Null&#39;</span><span class="p">,</span> <span class="n">ci_level</span><span class="o">=</span><span class="n">CIpct</span><span class="p">,</span>
                          <span class="n">threshold_level</span><span class="o">=</span><span class="n">CIpct</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">xlabel</span><span class="o">=</span><span class="s1">&#39;PLS Dim&#39;</span><span class="p">,</span>
                          <span class="n">ylabel</span><span class="o">=</span><span class="s1">&#39;Explained</span><span class="se">\n</span><span class="s1">Covariance&#39;</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span></div></div>

<div class="viewcode-block" id="ShapePLS_2B"><a class="viewcode-back" href="../../python_shape_stats.html#python_shape_stats.statistical_shape_models.ShapePLS_2B">[docs]</a><span class="k">class</span> <span class="nc">ShapePLS_2B</span><span class="p">(</span><span class="n">PLS_2B</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">_is_x_shape</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_x</span><span class="p">,</span><span class="n">ShapePCA</span><span class="p">)</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">_is_y_shape</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_y</span><span class="p">,</span><span class="n">ShapePCA</span><span class="p">)</span>


    <span class="k">def</span> <span class="nf">_get_base_polydata</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">bp</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_x_shape</span><span class="p">:</span>
            <span class="n">bp</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_x</span><span class="o">.</span><span class="n">average_polydata</span><span class="p">))</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_y_shape</span><span class="p">:</span>
            <span class="n">bp</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_y</span><span class="o">.</span><span class="n">average_polydata</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">bp</span>

    <span class="k">def</span> <span class="nf">_get_latent_vectors</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">dim</span><span class="p">):</span>
        <span class="n">vectors</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_x_shape</span><span class="p">:</span>
            <span class="n">vectors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">helpers</span><span class="o">.</span><span class="n">landmark_2d_to_3d</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_x</span><span class="o">.</span><span class="n">eig_vec</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="bp">self</span><span class="o">.</span><span class="n">x_projection_matrix</span><span class="p">[:,</span><span class="n">dim</span><span class="p">]))</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_y_shape</span><span class="p">:</span>
            <span class="n">vectors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">helpers</span><span class="o">.</span><span class="n">landmark_2d_to_3d</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_y</span><span class="o">.</span><span class="n">eig_vec</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="bp">self</span><span class="o">.</span><span class="n">y_projection_matrix</span><span class="p">[:,</span><span class="n">dim</span><span class="p">]))</span>
        <span class="k">return</span> <span class="n">vectors</span>

    <span class="k">def</span> <span class="nf">_get_frame_scalars</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">dim</span><span class="p">,</span><span class="n">max_sd</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span><span class="n">n_frames</span><span class="o">=</span><span class="mi">20</span><span class="p">):</span>
        <span class="n">sc_x</span> <span class="o">=</span> <span class="n">helpers</span><span class="o">.</span><span class="n">_generate_circular_sequence</span><span class="p">(</span><span class="o">-</span><span class="n">max_sd</span><span class="p">,</span> <span class="n">max_sd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">n_in_sequence</span><span class="o">=</span><span class="n">n_frames</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">x_scores</span><span class="p">[:,</span> <span class="n">dim</span><span class="p">])</span>
        <span class="n">sc_y</span> <span class="o">=</span> <span class="n">sc_x</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">inner_relation_coefs</span><span class="p">[</span><span class="n">dim</span><span class="p">]</span>
        <span class="n">frame_scalars</span> <span class="o">=</span> <span class="p">[</span><span class="n">sc_x</span><span class="p">,</span><span class="n">sc_y</span><span class="p">]</span>
        <span class="n">is_shape</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_is_x_shape</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">_is_y_shape</span><span class="p">]</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">frame_scalars</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="k">if</span> <span class="n">is_shape</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span>

    <span class="k">def</span> <span class="nf">_get_point_scalars</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">dim</span><span class="p">,</span><span class="n">direction</span><span class="p">):</span>
        <span class="n">pd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_base_polydata</span><span class="p">()</span>
        <span class="n">latent_vectors</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_latent_vectors</span><span class="p">(</span><span class="n">dim</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">direction</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;normal&#39;</span><span class="p">:</span>
            <span class="n">normals</span> <span class="o">=</span> <span class="p">[</span><span class="n">item</span><span class="o">.</span><span class="n">point_normals</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">pd</span><span class="p">]</span>
            <span class="n">scalars</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">normals</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">*</span><span class="n">latent_vectors</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">pd</span><span class="p">))]</span>
        <span class="k">elif</span> <span class="n">direction</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;total&#39;</span><span class="p">:</span>
            <span class="n">scalars</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">latent_vectors</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">pd</span><span class="p">))]</span>
        <span class="k">return</span> <span class="n">scalars</span>
    <span class="c1"># some methods specific for visualising paired latent dimensiona</span>
<div class="viewcode-block" id="ShapePLS_2B.animate_latent_dim"><a class="viewcode-back" href="../../python_shape_stats.html#python_shape_stats.statistical_shape_models.ShapePLS_2B.animate_latent_dim">[docs]</a>    <span class="k">def</span> <span class="nf">animate_latent_dim</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">dim</span><span class="p">,</span><span class="n">max_sd</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span><span class="n">n_frames</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Animates the shape transformations of a single latent dimension.</span>

<span class="sd">        :param dim: the latent dimension to visualise</span>
<span class="sd">        :param max_sd: the animation will go between +/- max_sd of the scores of the latent dimension</span>
<span class="sd">        :param n_frames: the number of frames for the animation</span>
<span class="sd">        :param kwargs: see helpers.animate_vectors</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>


        <span class="n">file_name</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;file_name&#39;</span><span class="p">,</span> <span class="s1">&#39;PLS_Dim&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">dim</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;.gif&#39;</span><span class="p">)</span>
        <span class="c1"># collect the average polydatas</span>
        <span class="n">base_polydata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_base_polydata</span><span class="p">()</span>
        <span class="n">vectors</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_latent_vectors</span><span class="p">(</span><span class="n">dim</span><span class="p">)</span>
        <span class="n">frame_scalars</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_frame_scalars</span><span class="p">(</span><span class="n">dim</span><span class="p">,</span><span class="n">max_sd</span><span class="o">=</span><span class="n">max_sd</span><span class="p">,</span><span class="n">n_frames</span><span class="o">=</span><span class="n">n_frames</span><span class="p">)</span>

        <span class="n">helpers</span><span class="o">.</span><span class="n">animate_vectors</span><span class="p">(</span><span class="n">base_polydata</span><span class="o">=</span><span class="n">base_polydata</span><span class="p">,</span><span class="n">point_vectors</span><span class="o">=</span><span class="n">vectors</span><span class="p">,</span><span class="n">frame_scalars</span><span class="o">=</span><span class="n">frame_scalars</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

<div class="viewcode-block" id="ShapePLS_2B.colormap_latent_dim"><a class="viewcode-back" href="../../python_shape_stats.html#python_shape_stats.statistical_shape_models.ShapePLS_2B.colormap_latent_dim">[docs]</a>    <span class="k">def</span> <span class="nf">colormap_latent_dim</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">dim</span><span class="p">,</span><span class="n">direction</span><span class="o">=</span><span class="s1">&#39;normal&#39;</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :param dim: the latent dimension to visualise</span>
<span class="sd">        :param direction: plots the shape transformtion along the surface normals (if set to &#39;normal&#39;) otherwise plots the total magnitude of the shape transformation per point (if set to &#39;total&#39;)</span>
<span class="sd">        :param kwargs: see helpers.plot_colormaps</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">file_name</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;file_name&#39;</span><span class="p">,</span><span class="s1">&#39;PLS_Dim&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">dim</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;.pdf&#39;</span>  <span class="p">)</span>
        <span class="n">pd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_base_polydata</span><span class="p">()</span>
        <span class="n">scalars</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_point_scalars</span><span class="p">(</span><span class="n">dim</span><span class="p">,</span><span class="n">direction</span><span class="p">)</span>
        <span class="n">helpers</span><span class="o">.</span><span class="n">plot_colormaps</span><span class="p">(</span><span class="n">pd</span><span class="p">,</span><span class="n">scalars</span><span class="p">,</span><span class="n">file_name</span><span class="o">=</span><span class="n">file_name</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="PLSHypothesisTest"><a class="viewcode-back" href="../../python_shape_stats.html#python_shape_stats.statistical_shape_models.PLSHypothesisTest">[docs]</a><span class="k">class</span> <span class="nc">PLSHypothesisTest</span><span class="p">(</span><span class="n">PLS</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_n_comp</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_coefs</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_method</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_var_r_squared</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_null_r_squared</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">coefs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_coefs</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">method</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_method</span>


    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">model_stats</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_assemble_model_stats</span><span class="p">()</span>



<div class="viewcode-block" id="PLSHypothesisTest.fit"><a class="viewcode-back" href="../../python_shape_stats.html#python_shape_stats.statistical_shape_models.PLSHypothesisTest.fit">[docs]</a>    <span class="k">def</span> <span class="nf">fit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;simpls&#39;</span><span class="p">,</span><span class="n">n_comp</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span><span class="n">center_x</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">center_y</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">standardize_x</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">standardize_y</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">observation_mask</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">observation_weights</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_center_x</span> <span class="o">=</span> <span class="n">center_x</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_center_y</span> <span class="o">=</span> <span class="n">center_y</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_standardize_x</span> <span class="o">=</span> <span class="n">standardize_x</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_standardize_y</span> <span class="o">=</span> <span class="n">standardize_y</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_observation_mask</span> <span class="o">=</span> <span class="n">observation_mask</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_observation_weights</span> <span class="o">=</span> <span class="n">observation_weights</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="n">x</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">y</span> <span class="o">=</span> <span class="n">y</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_method</span> <span class="o">=</span> <span class="n">method</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_n_comp</span> <span class="o">=</span> <span class="n">n_comp</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_coefs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fit</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_x0</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">_y0</span><span class="p">,</span><span class="n">n_comp</span><span class="p">,</span><span class="n">method</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">method</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_var_r_squared</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compute_var_r_squared</span><span class="p">()</span></div>



<div class="viewcode-block" id="PLSHypothesisTest.run_permutation_test"><a class="viewcode-back" href="../../python_shape_stats.html#python_shape_stats.statistical_shape_models.PLSHypothesisTest.run_permutation_test">[docs]</a>    <span class="k">def</span> <span class="nf">run_permutation_test</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">vars_to_test</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span><span class="n">test_full_model</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span><span class="n">seed</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">n_reps</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span><span class="n">n_jobs</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="n">perm_models</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fit_permuted_models</span><span class="p">(</span><span class="n">vars_to_test</span><span class="o">=</span><span class="n">vars_to_test</span><span class="p">,</span><span class="n">test_full_model</span><span class="o">=</span><span class="n">test_full_model</span><span class="p">,</span><span class="n">seed</span><span class="o">=</span><span class="n">seed</span><span class="p">,</span><span class="n">n_reps</span><span class="o">=</span><span class="n">n_reps</span><span class="p">,</span><span class="n">n_jobs</span><span class="o">=</span><span class="n">n_jobs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_null_r_squared</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_unpack_null_distributions</span><span class="p">(</span><span class="n">perm_models</span><span class="p">)</span></div>


    <span class="k">def</span> <span class="nf">_unpack_null_distributions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">perm_models</span><span class="p">):</span>
        <span class="n">out</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="n">keys</span> <span class="o">=</span> <span class="p">[</span><span class="n">item</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">perm_models</span><span class="o">.</span><span class="n">keys</span><span class="p">()]</span>
        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">keys</span><span class="p">)),</span> <span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Unpacking&quot;</span><span class="p">,</span> <span class="n">ascii</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="mi">75</span><span class="p">):</span>
            <span class="n">key</span> <span class="o">=</span> <span class="n">keys</span><span class="p">[</span><span class="n">x</span><span class="p">]</span>
            <span class="n">out</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compute_rsquared</span><span class="p">(</span><span class="n">perm_models</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">perm_models</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">out</span>

    <span class="k">def</span> <span class="nf">_fit_permuted_models</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">vars_to_test</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span><span class="n">test_full_model</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span><span class="n">seed</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">n_reps</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span><span class="n">n_jobs</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">_run_parallel</span><span class="p">(</span><span class="n">x0</span><span class="p">,</span><span class="n">y0</span><span class="p">):</span>
            <span class="n">ss</span> <span class="o">=</span> <span class="n">rng</span><span class="o">.</span><span class="n">bit_generator</span><span class="o">.</span><span class="n">_seed_seq</span>
            <span class="n">child_states</span> <span class="o">=</span> <span class="n">ss</span><span class="o">.</span><span class="n">spawn</span><span class="p">(</span><span class="n">n_reps</span><span class="p">)</span>
            <span class="k">with</span> <span class="n">joblib_progress</span><span class="p">(</span><span class="s1">&#39;Running permutation test...&#39;</span><span class="p">,</span> <span class="n">n_reps</span><span class="p">):</span>
                <span class="n">res</span> <span class="o">=</span> <span class="n">joblib</span><span class="o">.</span><span class="n">Parallel</span><span class="p">(</span><span class="n">n_jobs</span><span class="o">=</span><span class="n">n_jobs</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">)(</span>
                    <span class="n">joblib</span><span class="o">.</span><span class="n">delayed</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_perm_test_one_iter</span><span class="p">)(</span><span class="n">x0</span><span class="p">,</span><span class="n">y0</span><span class="p">,</span><span class="n">n_comp</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">method</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">method</span><span class="p">,</span>
                                                             <span class="n">seed</span><span class="o">=</span><span class="n">child_states</span><span class="p">[</span><span class="n">x</span><span class="p">])</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_reps</span><span class="p">))</span>
            <span class="n">_</span><span class="p">,</span><span class="n">res</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">res</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">res</span>

        <span class="n">rng</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">default_rng</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>
        <span class="c1"># which variables will be tested</span>
        <span class="k">if</span> <span class="n">vars_to_test</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">vars_to_test</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">helpers</span><span class="o">.</span><span class="n">my_is_iterable</span><span class="p">(</span><span class="n">vars_to_test</span><span class="p">):</span>
                <span class="n">vars_to_test</span> <span class="o">=</span> <span class="p">[</span><span class="n">vars_to_test</span><span class="p">]</span>
        <span class="n">vars_to_test</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_find_var_in_x</span><span class="p">(</span><span class="n">item</span><span class="p">,</span><span class="n">search_in_x_treated</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">vars_to_test</span><span class="p">]</span>
        <span class="c1"># for each variable get the results</span>
        <span class="n">results</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">vars_to_test</span><span class="p">:</span>
            <span class="n">x0</span><span class="p">,</span><span class="n">y0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_reduced_xy</span><span class="p">(</span><span class="n">var</span><span class="p">)</span>
            <span class="n">results</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="n">var</span><span class="p">]]</span> <span class="o">=</span> <span class="p">(</span><span class="n">_run_parallel</span><span class="p">(</span><span class="n">x0</span><span class="p">,</span><span class="n">y0</span><span class="p">),</span><span class="n">y0</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">test_full_model</span><span class="p">:</span>
            <span class="n">results</span><span class="p">[</span><span class="s1">&#39;Full Model&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">_run_parallel</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_x0</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">_y0</span><span class="p">),</span><span class="bp">self</span><span class="o">.</span><span class="n">_y0</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">results</span>

    <span class="k">def</span> <span class="nf">_compute_rsquared</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">res</span><span class="p">,</span><span class="n">y0</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">helpers</span><span class="o">.</span><span class="n">my_is_iterable</span><span class="p">(</span><span class="n">res</span><span class="p">):</span>
            <span class="n">res</span> <span class="o">=</span> <span class="p">[</span><span class="n">res</span><span class="p">]</span>
        <span class="n">tot_var</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">y0</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">res_var</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">res</span><span class="p">])</span>
        <span class="k">return</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">res_var</span> <span class="o">/</span> <span class="n">tot_var</span><span class="p">,)</span>

    <span class="k">def</span> <span class="nf">_compute_var_r_squared</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">out</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="n">x0</span><span class="p">,</span><span class="n">y0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_reduced_xy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_find_var_in_x</span><span class="p">(</span><span class="n">var</span><span class="p">,</span><span class="kc">False</span><span class="p">))</span>
            <span class="n">_</span><span class="p">,</span><span class="n">res</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fit_residualize</span><span class="p">(</span><span class="n">x0</span><span class="p">,</span> <span class="n">y0</span><span class="p">,</span> <span class="n">n_comp</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">method</span><span class="p">)</span>
            <span class="n">out</span><span class="p">[</span><span class="n">var</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compute_rsquared</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="n">y0</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">out</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_perm_test_one_iter</span><span class="p">(</span><span class="n">x0</span><span class="p">,</span><span class="n">y0</span><span class="p">,</span><span class="n">n_comp</span><span class="p">,</span><span class="n">method</span><span class="p">,</span><span class="n">seed</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="n">rng</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">default_rng</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>
        <span class="c1"># permute rows of x0</span>
        <span class="n">shuff_x</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">x0</span><span class="p">)</span>
        <span class="n">shuff_x</span> <span class="o">=</span> <span class="n">shuff_x</span><span class="p">[</span><span class="n">rng</span><span class="o">.</span><span class="n">permutation</span><span class="p">(</span><span class="n">x0</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="p">:]</span>
        <span class="k">return</span> <span class="n">PLSHypothesisTest</span><span class="o">.</span><span class="n">_fit_residualize</span><span class="p">(</span><span class="n">shuff_x</span><span class="p">,</span> <span class="n">y0</span><span class="p">,</span> <span class="n">n_comp</span><span class="o">=</span><span class="n">n_comp</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="n">method</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_reduced_xy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">var</span><span class="p">):</span>
        <span class="n">var_cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">item</span><span class="o">==</span><span class="n">var</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_x_block_var_indices</span><span class="p">]</span>
        <span class="n">co_var_cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">item</span><span class="o">!=</span><span class="n">var</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_x_block_var_indices</span><span class="p">]</span>
        <span class="n">var</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_x0</span><span class="p">[:,</span> <span class="n">var_cols</span><span class="p">]</span>
        <span class="n">co_var</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_x0</span><span class="p">[:,</span> <span class="n">co_var_cols</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">sum</span><span class="p">(</span><span class="n">co_var_cols</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_x0</span><span class="p">),</span><span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_y0</span><span class="p">)</span>
        <span class="n">_</span><span class="p">,</span><span class="n">x0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fit_residualize</span><span class="p">(</span><span class="n">co_var</span><span class="p">,</span> <span class="n">var</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">method</span><span class="p">)</span>
        <span class="n">_</span><span class="p">,</span><span class="n">y0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fit_residualize</span><span class="p">(</span><span class="n">co_var</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">_y0</span><span class="p">,</span><span class="n">method</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">method</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">x0</span><span class="p">,</span> <span class="n">y0</span>

    <span class="k">def</span> <span class="nf">_assemble_model_stats</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_var_r_squared</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_var_r_squared</span><span class="p">),</span><span class="mi">2</span><span class="p">])</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span><span class="n">index</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_var_r_squared</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;R_2&#39;</span><span class="p">,</span><span class="s1">&#39;p&#39;</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_var_r_squared</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">R2</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_var_r_squared</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">out</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">key</span><span class="p">,</span><span class="s1">&#39;R_2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">R2</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_null_r_squared</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_null_r_squared</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="n">null_r2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_null_r_squared</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">p</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">null_r2</span><span class="o">&gt;</span><span class="n">R2</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">null_r2</span><span class="p">)</span>
                    <span class="n">out</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">key</span><span class="p">,</span><span class="s1">&#39;p&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">p</span>
        <span class="k">return</span> <span class="n">out</span>
        <span class="c1"># get variable</span>



    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_fit</span><span class="p">(</span><span class="n">x0</span><span class="p">,</span><span class="n">y0</span><span class="p">,</span><span class="n">n_comp</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">method</span><span class="o">=</span><span class="s1">&#39;simpls&#39;</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">n_comp</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">n_comp</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">x0</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;simpls&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">simpls</span><span class="p">(</span><span class="n">x0</span><span class="p">,</span> <span class="n">y0</span><span class="p">,</span> <span class="n">n_comp</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;pls&#39;</span><span class="p">:</span>
            <span class="n">PLSMod</span> <span class="o">=</span> <span class="n">PLSRegression</span><span class="p">(</span><span class="n">n_components</span><span class="o">=</span><span class="n">n_comp</span><span class="p">,</span><span class="n">scale</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">PLSMod</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">x0</span><span class="p">,</span><span class="n">y0</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">PLSMod</span><span class="o">.</span><span class="n">coef_</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_fit_residualize</span><span class="p">(</span><span class="n">x0</span><span class="p">,</span><span class="n">y0</span><span class="p">,</span><span class="n">n_comp</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span><span class="n">method</span> <span class="o">=</span> <span class="s1">&#39;simpls&#39;</span><span class="p">):</span>
        <span class="n">coefs</span> <span class="o">=</span> <span class="n">PLSHypothesisTest</span><span class="o">.</span><span class="n">_fit</span><span class="p">(</span><span class="n">x0</span><span class="p">,</span><span class="n">y0</span><span class="p">,</span><span class="n">n_comp</span><span class="o">=</span><span class="n">n_comp</span><span class="p">,</span><span class="n">method</span> <span class="o">=</span> <span class="n">method</span><span class="p">)</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">y0</span> <span class="o">-</span> <span class="n">PLSHypothesisTest</span><span class="o">.</span><span class="n">_predict</span><span class="p">(</span><span class="n">coefs</span><span class="p">,</span><span class="n">x0</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">coefs</span><span class="p">,</span> <span class="n">res</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_predict</span><span class="p">(</span><span class="n">coefs</span><span class="p">,</span><span class="n">x0</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">x0</span> <span class="o">@</span> <span class="n">coefs</span>
    <span class="k">def</span> <span class="nf">_get_regression_vectors</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x_vars</span><span class="p">,</span><span class="n">reverse</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">helpers</span><span class="o">.</span><span class="n">my_is_iterable</span><span class="p">(</span><span class="n">x_vars</span><span class="p">):</span>
            <span class="n">x_vars</span> <span class="o">=</span> <span class="p">[</span><span class="n">x_vars</span><span class="p">]</span>
        <span class="k">return</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_regression_vector</span><span class="p">(</span><span class="n">item</span><span class="p">,</span><span class="n">reverse</span><span class="o">=</span><span class="n">reverse</span><span class="p">)</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">x_vars</span><span class="p">]</span>
    <span class="k">def</span> <span class="nf">_get_regression_vector</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">x_var</span><span class="p">,</span><span class="n">reverse</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="n">row</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_find_var_in_x</span><span class="p">(</span><span class="n">x_var</span><span class="p">)</span>
        <span class="n">vec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coefs</span><span class="p">[</span><span class="n">row</span><span class="p">,:]</span>
        <span class="k">if</span> <span class="n">reverse</span><span class="p">:</span>
            <span class="n">vec</span> <span class="o">=</span> <span class="n">vec</span><span class="o">*-</span><span class="mi">1</span>
        <span class="k">return</span> <span class="n">vec</span>

    <span class="k">def</span> <span class="nf">_find_var_in_x</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">x_var</span><span class="p">,</span><span class="n">search_in_x_treated</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">search_in_x_treated</span><span class="p">:</span>
            <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">x_treated</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">x</span>
        <span class="c1"># if integer assume it is a numeric index to  row of coefs</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x_var</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">x_var</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;x_var appears to be an integer index, but is greater than the variables in x&#39;</span><span class="p">)</span>
                <span class="n">row</span> <span class="o">=</span> <span class="n">x_var</span>
        <span class="k">else</span><span class="p">:</span>  <span class="c1"># try to see if you can find it</span>
            <span class="n">is_match</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">([</span><span class="n">item</span> <span class="o">==</span> <span class="n">x_var</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">x</span><span class="o">.</span><span class="n">columns</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">is_match</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;No match for x_var (&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">x_var</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;) found values&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span>
                    <span class="p">[</span><span class="n">item</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">x</span><span class="o">.</span><span class="n">columns</span><span class="p">]))</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">is_match</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s1">&#39;Multiple matches for x_var (&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">x_var</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;) found values&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span>
                        <span class="p">[</span><span class="n">item</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">x</span><span class="o">.</span><span class="n">columns</span><span class="p">]))</span>
            <span class="n">row</span> <span class="o">=</span> <span class="n">is_match</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">row</span>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_get_residuals</span><span class="p">(</span><span class="n">coefs</span><span class="p">,</span><span class="n">x0</span><span class="p">,</span><span class="n">y0</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">y0</span> <span class="o">-</span> <span class="n">PLSHypothesisTest</span><span class="o">.</span><span class="n">_predict</span><span class="p">(</span><span class="n">coefs</span><span class="p">,</span><span class="n">x0</span><span class="p">)</span></div>

<div class="viewcode-block" id="ShapePLSHypothesisTest"><a class="viewcode-back" href="../../python_shape_stats.html#python_shape_stats.statistical_shape_models.ShapePLSHypothesisTest">[docs]</a><span class="k">class</span> <span class="nc">ShapePLSHypothesisTest</span><span class="p">(</span><span class="n">PLSHypothesisTest</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">y</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">y</span>
    <span class="nd">@y</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">y</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">val</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span><span class="n">ShapePCA</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;y is expected to be an instance of the ShapePCA class&#39;</span><span class="p">)</span>
        <span class="nb">super</span><span class="p">(</span><span class="vm">__class__</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">)</span><span class="o">.</span><span class="n">y</span><span class="o">.</span><span class="fm">__set__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_compute_rsquared</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">res</span><span class="p">,</span><span class="n">y0</span><span class="p">):</span>
        <span class="n">ef_rsq</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">_compute_rsquared</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="n">y0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="c1"># compute r squared per point</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">helpers</span><span class="o">.</span><span class="n">my_is_iterable</span><span class="p">(</span><span class="n">res</span><span class="p">):</span>
            <span class="n">res</span> <span class="o">=</span> <span class="p">[</span><span class="n">res</span><span class="p">]</span>
        <span class="c1"># rotate back to the space of landmarks and reshape</span>
        <span class="n">res</span> <span class="o">=</span> <span class="p">[</span><span class="n">helpers</span><span class="o">.</span><span class="n">landmark_2d_to_3d</span><span class="p">(</span><span class="n">item</span> <span class="o">@</span> <span class="bp">self</span><span class="o">.</span><span class="n">_y</span><span class="o">.</span><span class="n">eig_vec</span><span class="p">)</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">res</span><span class="p">]</span>
        <span class="n">y0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_3d</span><span class="p">(</span><span class="n">helpers</span><span class="o">.</span><span class="n">landmark_2d_to_3d</span><span class="p">(</span><span class="n">y0</span> <span class="o">@</span> <span class="bp">self</span><span class="o">.</span><span class="n">_y</span><span class="o">.</span><span class="n">eig_vec</span><span class="p">))</span>
        <span class="n">ss_per_point</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span> <span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">x</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))[:,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>
        <span class="n">tot_var</span> <span class="o">=</span> <span class="n">ss_per_point</span><span class="p">(</span><span class="n">y0</span><span class="p">)</span>
        <span class="n">res_var</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">([</span><span class="n">ss_per_point</span><span class="p">(</span><span class="n">item</span><span class="p">)</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">res</span><span class="p">])</span>
        <span class="n">point_rsqu</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">res_var</span> <span class="o">/</span> <span class="n">tot_var</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">ef_rsq</span><span class="p">,</span><span class="n">point_rsqu</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_get_regression_vector</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x_var</span><span class="p">,</span><span class="n">reverse</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="n">vec</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">_get_regression_vector</span><span class="p">(</span><span class="n">x_var</span><span class="p">,</span><span class="n">reverse</span><span class="o">=</span><span class="n">reverse</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">helpers</span><span class="o">.</span><span class="n">landmark_2d_to_3d</span><span class="p">(</span><span class="n">vec</span> <span class="o">@</span> <span class="bp">self</span><span class="o">.</span><span class="n">_y</span><span class="o">.</span><span class="n">eig_vec</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_get_point_regression_coefs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">direction</span><span class="p">,</span><span class="n">x_vars</span><span class="p">,</span><span class="n">reverse</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">helpers</span><span class="o">.</span><span class="n">my_is_iterable</span><span class="p">(</span><span class="n">x_vars</span><span class="p">):</span>
            <span class="n">x_vars</span> <span class="o">=</span> <span class="p">[</span><span class="n">x_vars</span><span class="p">]</span>
        <span class="n">vecs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_regression_vectors</span><span class="p">(</span><span class="n">x_vars</span><span class="p">,</span><span class="n">reverse</span><span class="o">=</span><span class="n">reverse</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">helpers</span><span class="o">.</span><span class="n">_vecs_to_scalars</span><span class="p">(</span><span class="n">vecs</span><span class="p">,</span><span class="n">direction</span><span class="o">=</span><span class="n">direction</span><span class="p">,</span><span class="n">poly</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_y</span><span class="o">.</span><span class="n">average_polydata</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_point_r_squared</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">x_vars</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">helpers</span><span class="o">.</span><span class="n">my_is_iterable</span><span class="p">(</span><span class="n">x_vars</span><span class="p">):</span>
            <span class="n">x_vars</span> <span class="o">=</span> <span class="p">[</span><span class="n">x_vars</span><span class="p">]</span>
        <span class="c1"># check variable exists</span>
        <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_find_var_in_x</span><span class="p">(</span><span class="n">item</span><span class="p">,</span><span class="n">search_in_x_treated</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">x_vars</span><span class="p">]</span>
        <span class="k">return</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_var_r_squared</span><span class="p">[</span><span class="n">item</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">x_vars</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">_get_point_p_values</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">x_vars</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">helpers</span><span class="o">.</span><span class="n">my_is_iterable</span><span class="p">(</span><span class="n">x_vars</span><span class="p">):</span>
            <span class="n">x_vars</span> <span class="o">=</span> <span class="p">[</span><span class="n">x_vars</span><span class="p">]</span>
            <span class="c1"># check variable exists</span>
        <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_find_var_in_x</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">search_in_x_treated</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">x_vars</span><span class="p">]</span>
        <span class="n">out</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">x_vars</span><span class="p">:</span>
            <span class="n">r</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_var_r_squared</span><span class="p">[</span><span class="n">var</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">null_rsqu</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_null_r_squared</span><span class="p">[</span><span class="n">var</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">n_perms</span> <span class="o">=</span> <span class="n">null_rsqu</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">p</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">null_rsqu</span><span class="o">-</span><span class="n">r</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="n">n_perms</span>
            <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">out</span>

<div class="viewcode-block" id="ShapePLSHypothesisTest.plot_coefficients"><a class="viewcode-back" href="../../python_shape_stats.html#python_shape_stats.statistical_shape_models.ShapePLSHypothesisTest.plot_coefficients">[docs]</a>    <span class="k">def</span> <span class="nf">plot_coefficients</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">x_vars</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">direction</span> <span class="o">=</span> <span class="s1">&#39;normal&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plot the regression coefficients as colormaps</span>

<span class="sd">        :param x_vars: the names of the x variables plot</span>
<span class="sd">        :param direction: either &#39;normal&#39; or &#39;total&#39; plotting the magnitude of the coefficients along the surface normals or their total magnitude</span>
<span class="sd">        :param kwargs: see helpers.plot_colormaps</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">file_name</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;file_name&#39;</span><span class="p">,</span><span class="s1">&#39;regression_coeffs&#39;</span><span class="p">)</span>  <span class="c1"># +str(x_vars).replace(&#39;[&#39;,&#39;&#39;).replace.(&#39;]&#39;,&#39;&#39;).replace(&#39;,&#39;,&#39;_&#39;).replace(&#39; &#39;,&#39;&#39;)</span>
        <span class="n">pd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_y</span><span class="o">.</span><span class="n">average_polydata</span>
        <span class="n">point_scalars</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_point_regression_coefs</span><span class="p">(</span><span class="n">direction</span><span class="o">=</span><span class="n">direction</span><span class="p">,</span> <span class="n">x_vars</span><span class="o">=</span><span class="n">x_vars</span><span class="p">)</span>
        <span class="n">helpers</span><span class="o">.</span><span class="n">plot_colormaps</span><span class="p">(</span><span class="n">pd</span><span class="p">,</span><span class="n">point_scalars</span><span class="p">,</span><span class="n">file_name</span><span class="o">=</span><span class="n">file_name</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>
<div class="viewcode-block" id="ShapePLSHypothesisTest.plot_r_squared"><a class="viewcode-back" href="../../python_shape_stats.html#python_shape_stats.statistical_shape_models.ShapePLSHypothesisTest.plot_r_squared">[docs]</a>    <span class="k">def</span> <span class="nf">plot_r_squared</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">x_vars</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plots the partial r-sqaured for the specified variables for each point</span>

<span class="sd">        :param x_vars: the names of the x variables plot</span>
<span class="sd">        :param kwargs: see helpers.plot_colormaps</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">file_name</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;file_name&#39;</span><span class="p">,</span> <span class="s1">&#39;regression_r_squared&#39;</span><span class="p">)</span>
        <span class="n">pd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_y</span><span class="o">.</span><span class="n">average_polydata</span>
        <span class="n">point_scalars</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_point_r_squared</span><span class="p">(</span><span class="n">x_vars</span><span class="o">=</span><span class="n">x_vars</span><span class="p">)</span>
        <span class="n">helpers</span><span class="o">.</span><span class="n">plot_colormaps</span><span class="p">(</span><span class="n">pd</span><span class="p">,</span><span class="n">point_scalars</span><span class="p">,</span><span class="n">file_name</span><span class="o">=</span><span class="n">file_name</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

<div class="viewcode-block" id="ShapePLSHypothesisTest.plot_p_values"><a class="viewcode-back" href="../../python_shape_stats.html#python_shape_stats.statistical_shape_models.ShapePLSHypothesisTest.plot_p_values">[docs]</a>    <span class="k">def</span> <span class="nf">plot_p_values</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">x_vars</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">p_crit</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plots the significance of of the effect at each point as a binary colormap</span>

<span class="sd">        :param x_vars: the names of the x variables plot</span>
<span class="sd">        :param p_crit: the significance threshold</span>
<span class="sd">        :param kwargs: see helpers.plot_colormaps</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">file_name</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;file_name&#39;</span><span class="p">,</span><span class="s1">&#39;regression_point_p_values&#39;</span><span class="p">)</span>
        <span class="n">cmap</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;cmap&#39;</span><span class="p">,</span><span class="s1">&#39;summer&#39;</span><span class="p">)</span>
        <span class="n">clim</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;clim&#39;</span><span class="p">,[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">plot_color_bar</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;plot_color_bar&#39;</span><span class="p">,</span><span class="kc">False</span><span class="p">)</span>

        <span class="n">pd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_y</span><span class="o">.</span><span class="n">average_polydata</span>
        <span class="n">point_scalars</span> <span class="o">=</span> <span class="p">[(</span><span class="n">item</span><span class="o">&lt;</span><span class="n">p_crit</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_point_p_values</span><span class="p">(</span><span class="n">x_vars</span><span class="o">=</span><span class="n">x_vars</span><span class="p">)]</span>
        <span class="n">helpers</span><span class="o">.</span><span class="n">plot_colormaps</span><span class="p">(</span><span class="n">pd</span><span class="p">,</span><span class="n">point_scalars</span><span class="p">,</span><span class="n">file_name</span> <span class="o">=</span> <span class="n">file_name</span><span class="p">,</span><span class="n">cmap</span> <span class="o">=</span> <span class="n">cmap</span><span class="p">,</span><span class="n">clim</span><span class="o">=</span><span class="n">clim</span><span class="p">,</span><span class="n">plot_color_bar</span><span class="o">=</span><span class="n">plot_color_bar</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

<div class="viewcode-block" id="ShapePLSHypothesisTest.animate_coefficients"><a class="viewcode-back" href="../../python_shape_stats.html#python_shape_stats.statistical_shape_models.ShapePLSHypothesisTest.animate_coefficients">[docs]</a>    <span class="k">def</span> <span class="nf">animate_coefficients</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">vars</span><span class="p">,</span> <span class="n">max_sd</span> <span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span> <span class="n">n_frames</span> <span class="p">:</span> <span class="nb">int</span> <span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Visualise the regression coefficients as animations and save as a gif.</span>

<span class="sd">        :param vars: the names of the x variables plot</span>
<span class="sd">        :param max_sd: animate between the predicted shapes at +/- max_sd of standrad deviation of the predictor</span>
<span class="sd">        :param n_frames: the number of frames for the animation</span>
<span class="sd">        :param kwargs: see helpers.animate_vectors</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">helpers</span><span class="o">.</span><span class="n">my_is_iterable</span><span class="p">(</span><span class="nb">vars</span><span class="p">):</span>
            <span class="nb">vars</span> <span class="o">=</span> <span class="p">[</span><span class="nb">vars</span><span class="p">]</span>

        <span class="n">file_name</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;file_name&#39;</span><span class="p">,</span><span class="s1">&#39;regression&#39;</span><span class="p">)</span>  <span class="c1"># +str(x_vars).replace(&#39;[&#39;,&#39;&#39;).replace.(&#39;]&#39;,&#39;&#39;).replace(&#39;,&#39;,&#39;_&#39;).replace(&#39; &#39;,&#39;&#39;)</span>
        <span class="n">title</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;title&#39;</span><span class="p">,</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">vars</span><span class="p">])</span>

        <span class="c1"># get the standard deviations</span>
        <span class="n">sds</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x_treated</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span><span class="bp">self</span><span class="o">.</span><span class="n">_find_var_in_x</span><span class="p">(</span><span class="nb">vars</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">search_in_x_treated</span><span class="o">=</span><span class="kc">True</span><span class="p">)])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="nb">vars</span><span class="p">))]</span>

        <span class="n">vec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_regression_vectors</span><span class="p">(</span><span class="nb">vars</span><span class="p">)</span>
        <span class="n">frame_scalars</span> <span class="o">=</span> <span class="p">[</span><span class="n">helpers</span><span class="o">.</span><span class="n">_generate_circular_sequence</span><span class="p">(</span><span class="n">max_sd</span><span class="o">*</span><span class="n">sds</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="o">-</span><span class="n">max_sd</span><span class="o">*</span><span class="n">sds</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">n_in_sequence</span><span class="o">=</span><span class="n">n_frames</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="nb">vars</span><span class="p">))]</span>
        <span class="n">polydatas</span> <span class="o">=</span> <span class="p">[</span><span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_y</span><span class="o">.</span><span class="n">average_polydata</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="nb">vars</span><span class="p">))]</span>
        <span class="c1"># set default values of some of the keyword arguments</span>
             <span class="c1"># make animation</span>
        <span class="n">helpers</span><span class="o">.</span><span class="n">animate_vectors</span><span class="p">(</span><span class="n">polydatas</span><span class="p">,</span> <span class="n">vec</span><span class="p">,</span> <span class="n">frame_scalars</span><span class="p">,</span> <span class="n">file_name</span><span class="o">=</span><span class="n">file_name</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="n">title</span><span class="p">,</span>
                                 <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div></div>












<div class="viewcode-block" id="simpls"><a class="viewcode-back" href="../../python_shape_stats.html#python_shape_stats.statistical_shape_models.simpls">[docs]</a><span class="k">def</span> <span class="nf">simpls</span><span class="p">(</span><span class="n">x0</span><span class="p">,</span> <span class="n">y0</span><span class="p">,</span> <span class="n">n_comp</span><span class="p">):</span>
    <span class="c1"># this is a straightforward port of the simpls algorithm implemented in MATLABs plsregress</span>

    <span class="n">n</span><span class="p">,</span> <span class="n">dx</span> <span class="o">=</span> <span class="n">x0</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">dy</span> <span class="o">=</span> <span class="n">y0</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

    <span class="n">x_loadings</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">dx</span><span class="p">,</span> <span class="n">n_comp</span><span class="p">])</span>
    <span class="n">y_loadings</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">dy</span><span class="p">,</span> <span class="n">n_comp</span><span class="p">])</span>

    <span class="n">x_scores</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">n</span><span class="p">,</span> <span class="n">n_comp</span><span class="p">])</span>
    <span class="n">y_scores</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">n</span><span class="p">,</span> <span class="n">n_comp</span><span class="p">])</span>

    <span class="n">weights</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">dx</span><span class="p">,</span> <span class="n">n_comp</span><span class="p">])</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">dx</span><span class="p">,</span> <span class="n">n_comp</span><span class="p">])</span>  <span class="c1"># not part of the algorithm, will collect ri vectors for my own interest</span>
    <span class="n">v</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">dx</span><span class="p">,</span> <span class="n">n_comp</span><span class="p">])</span>

    <span class="n">cov</span> <span class="o">=</span> <span class="n">x0</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">y0</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_comp</span><span class="p">):</span>
        <span class="n">u</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">vt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">svd</span><span class="p">(</span><span class="n">cov</span><span class="p">,</span> <span class="n">full_matrices</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
       <span class="c1"># try:</span>
        <span class="n">ri</span> <span class="o">=</span> <span class="n">u</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>
   <span class="c1">#     except IndexError:</span>
     <span class="c1">#       k = aa</span>
        <span class="n">ci</span> <span class="o">=</span> <span class="n">vt</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span>
        <span class="n">si</span> <span class="o">=</span> <span class="n">s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="n">r</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">ri</span>

        <span class="n">ti</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">x0</span><span class="p">,</span> <span class="n">ri</span><span class="p">)</span>  <span class="c1"># projection onto ri</span>
        <span class="n">normti</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">ti</span><span class="p">)</span>
        <span class="n">ti</span> <span class="o">=</span> <span class="n">ti</span> <span class="o">/</span> <span class="n">normti</span>
        <span class="n">x_loadings</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">x0</span><span class="p">),</span> <span class="n">ti</span><span class="p">)</span>

        <span class="n">qi</span> <span class="o">=</span> <span class="n">si</span> <span class="o">*</span> <span class="n">ci</span> <span class="o">/</span> <span class="n">normti</span>
        <span class="n">y_loadings</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">qi</span>

        <span class="n">x_scores</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">ti</span>
        <span class="n">y_scores</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">y0</span><span class="p">,</span> <span class="n">qi</span><span class="p">)</span>

        <span class="n">weights</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">ri</span> <span class="o">/</span> <span class="n">normti</span>

        <span class="c1"># update orthonormal basis with modified Gramm-Schmidt</span>
        <span class="n">vi</span> <span class="o">=</span> <span class="n">x_loadings</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">repeat</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span><span class="p">):</span>
                <span class="n">vj</span> <span class="o">=</span> <span class="n">v</span><span class="p">[:,</span> <span class="n">j</span><span class="p">]</span>
                <span class="n">vi</span> <span class="o">=</span> <span class="n">vi</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">vj</span><span class="p">,</span> <span class="n">vi</span><span class="p">)</span> <span class="o">*</span> <span class="n">vj</span>

        <span class="n">vi</span> <span class="o">=</span> <span class="n">vi</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">vi</span><span class="p">)</span>
        <span class="n">v</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">vi</span>


        <span class="c1"># deflate cov with respect to current vector</span>
        <span class="n">cov</span> <span class="o">=</span> <span class="n">cov</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">outer</span><span class="p">(</span><span class="n">vi</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">vi</span><span class="p">,</span> <span class="n">cov</span><span class="p">))</span>

        <span class="c1"># deflate cov again with respect to all previous vectors to ensure complete deflation</span>
        <span class="n">vi</span> <span class="o">=</span> <span class="n">v</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">:(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)]</span>
        <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># Vi will be a single column, numpy will only do this using np.outer</span>
            <span class="n">cov</span> <span class="o">=</span> <span class="n">cov</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">outer</span><span class="p">(</span><span class="n">vi</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">vi</span><span class="p">),</span> <span class="n">cov</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">cov</span> <span class="o">=</span> <span class="n">cov</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">vi</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">vi</span><span class="p">),</span> <span class="n">cov</span><span class="p">))</span>

    <span class="c1"># Orthogonalise Y-scores</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_comp</span><span class="p">):</span>
        <span class="n">ui</span> <span class="o">=</span> <span class="n">y_scores</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">repeat</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span><span class="p">):</span>
                <span class="n">tj</span> <span class="o">=</span> <span class="n">x_scores</span><span class="p">[:,</span> <span class="n">j</span><span class="p">]</span>
                <span class="n">ui</span> <span class="o">=</span> <span class="n">ui</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">tj</span><span class="p">,</span> <span class="n">ui</span><span class="p">)</span> <span class="o">*</span> <span class="n">tj</span>

        <span class="n">y_scores</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">ui</span>


    <span class="n">coefs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_2d</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">weights</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">y_loadings</span><span class="p">)))</span>
    <span class="k">return</span> <span class="n">coefs</span></div>

<div class="viewcode-block" id="pls_svd"><a class="viewcode-back" href="../../python_shape_stats.html#python_shape_stats.statistical_shape_models.pls_svd">[docs]</a><span class="k">def</span> <span class="nf">pls_svd</span><span class="p">(</span><span class="n">cross_cov</span><span class="p">):</span>
    <span class="p">[</span><span class="n">u</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">v</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">svd</span><span class="p">(</span><span class="n">cross_cov</span><span class="p">,</span> <span class="n">full_matrices</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></div>



</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2023, Harold Matthews.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>